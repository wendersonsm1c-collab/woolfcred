<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WolfCred - Gestão Financeira Inteligente</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            /* Cores Principais e de Ação - Refinadas com base no logo yTC64oV.png (azul predominante) */
            --primary: #4A64A8;     /* Azul forte do logo */
            --primary-light: #778BB7;  /* Azul médio, para hovers e detalhes suaves */
            --primary-dark: #314670;   /* Azul escuro, para textos e ícones de destaque */
            
            --secondary: #28a745;      /* Verde sucesso */
            --secondary-light: #82E0AA;
            --secondary-dark: #1e7e34;
            
            --danger: #dc3545;         /* Vermelho perigo */
            --danger-light: #f5c6cb;
            --danger-dark: #a71d2a;
            
            --warning: #ffc107;         /* Amarelo aviso */
            --warning-light: #ffeeba;
            --warning-dark: #d39e00;
            
            --info: #17a2b8;            /* Azul informação */
            --info-light: #bee5eb;
            --info-dark: #117a8b;

            /* Cores Neutras e de Fundo */
            --background-light: #F8F9FA; /* Fundo principal claro */
            --surface-light: #FFFFFF;    /* Branco puro para cards */
            --border-light: #E9ECEF;     /* Borda sutil */
            --text-dark: #212529;        /* Texto principal quase preto */
            --text-medium: #495057;      /* Texto secundário */
            --text-light: #6c757d;       /* Texto suave */

            /* Variáveis para uso comum */
            --light: var(--background-light);
            --dark: var(--text-dark);
            --gray: var(--text-medium);
            --border: var(--border-light);
            --sidebar-bg: #212529;      /* Fundo da sidebar escuro */
            --card-bg: var(--surface-light);

            /* Sombras - Leves e sutis */
            --card-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
            --hover-card-shadow: 0 0.25rem 0.75rem rgba(0, 0, 0, 0.1);
            --modal-shadow: 0 0.5rem 1.5rem rgba(0, 0, 0, 0.2);

            /* Transições e Bordas */
            --hover-transition: all 0.2s ease-in-out;
            --border-radius-lg: 0.75rem; /* 12px */
            --border-radius-md: 0.5rem;  /* 8px */
            --border-radius-sm: 0.25rem; /* 4px */
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Poppins', sans-serif;
            -webkit-font-smoothing: antialiased; /* Otimiza renderização da fonte em WebKit */
            -moz-osx-font-smoothing: grayscale; /* Otimiza renderização da fonte em Firefox/macOS */
        }
        
        body {
            background-color: var(--background-light);
            color: var(--text-dark);
            line-height: 1.6;
            font-size: 1rem;
            overflow-x: hidden;
        }

        .container {
            display: flex;
            min-height: 100vh;
            background: var(--background-light);
        }
        
        /* Sidebar */
        .sidebar {
            width: 280px;
            background: var(--sidebar-bg);
            color: white;
            padding: 30px 0;
            box-shadow: 3px 0 15px rgba(0,0,0,0.1);
            position: relative;
            z-index: 100;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
        }
        
        .sidebar-header {
            padding: 0 25px 30px;
            text-align: center;
            border-bottom: 1px solid rgba(255,255,255,0.08);
            display: flex; 
            flex-direction: column; 
            align-items: center; 
        }
        
        /* Estilo para o logo do lobo na sidebar */
        .sidebar-header .logo-lobo {
            width: 140px;
            height: auto;
            margin-bottom: 15px;
            transition: var(--hover-transition);
            filter: brightness(1.1);
            transform: scale(0.95);
        }

        .sidebar-header .logo-lobo:hover {
            transform: scale(1);
            filter: brightness(1.2);
        }

        /* --- Fonte do Título do Site (WolfCred) --- */
        .sidebar-header h2 {
            font-size: 1.8rem; /* Changed from 2.2rem to 1.8rem */
            margin-bottom: 8px;
            color: white; 
            font-weight: 800; /* Mais pesado */
            letter-spacing: 1px; /* Espaçamento entre letras */
            text-shadow: 0 0 8px rgba(0,0,0,0.2), 0 0 15px rgba(74, 100, 168, 0.3); /* Sombra mais destacada */
        }
        
        .sidebar-header p {
            font-size: 0.85rem;
            color: rgba(255,255,255,0.7);
        }
        
        .sidebar-menu {
            list-style: none;
            flex-grow: 1;
            margin-top: 25px;
        }
        
        .sidebar-menu li {
            padding: 18px 25px;
            cursor: pointer;
            transition: var(--hover-transition);
            display: flex;
            align-items: center;
            gap: 15px;
            font-size: 1rem;
            border-left: 5px solid transparent;
            color: rgba(255,255,255,0.85);
        }
        
        .sidebar-menu li:hover {
            background: rgba(255,255,255,0.1);
            border-left-color: var(--primary-light);
            color: white;
            transform: translateX(5px);
        }
        
        .sidebar-menu li.active {
            background: rgba(74, 100, 168, 0.2);
            border-left: 5px solid var(--primary);
            color: white;
            font-weight: 600;
        }
        
        .sidebar-menu li.active i {
            color: var(--primary-light);
        }
        
        /* Main Content */
        .main-content {
            flex: 1;
            padding: 40px;
            overflow-y: auto;
            background-color: transparent;
        }
        
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 35px;
            padding-bottom: 25px;
            border-bottom: 1px solid var(--border-light);
            flex-wrap: wrap;
            gap: 20px;
        }
        
        .header h1 {
            font-size: 2.4rem;
            font-weight: 700;
            color: var(--text-dark);
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .tab-content {
            display: none;
            animation: fadeIn 0.4s ease-out;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(15px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .tab-content.active {
            display: block;
        }
        
        /* Cards */
        .card {
            background: var(--surface-light);
            border-radius: var(--border-radius-lg);
            box-shadow: var(--card-shadow);
            padding: 2.5rem;
            margin-bottom: 2.5rem;
            transition: var(--hover-transition);
            border: 1px solid var(--border-light);
        }
        
        .card:hover {
            box-shadow: var(--hover-card-shadow);
            transform: translateY(-0.15rem);
        }
        
        .stats-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
            gap: 25px;
            margin-bottom: 35px;
        }
        
        .stat-card {
            background: var(--surface-light);
            border-radius: var(--border-radius-lg);
            box-shadow: var(--card-shadow);
            padding: 2rem;
            display: flex;
            flex-direction: column;
            position: relative;
            overflow: hidden;
            border: 1px solid var(--border-light);
            transition: transform var(--hover-transition), box-shadow var(--hover-transition);
        }
        
        .stat-card:hover {
            transform: translateY(-0.25rem);
            box-shadow: var(--hover-card-shadow);
        }

        @keyframes pulse {
            0% { transform: scale(1); box-shadow: var(--card-shadow); }
            50% { transform: scale(1.01); box-shadow: 0 10px 25px rgba(74, 100, 168, 0.1); }
            100% { transform: scale(1); box-shadow: var(--card-shadow); }
        }

        .stat-card.pulse {
            animation: pulse 1.5s infinite alternate;
        }
        
        .stat-card h3 {
            font-size: 1.1rem;
            font-weight: 500;
            color: var(--text-medium);
            margin-bottom: 12px;
        }
        
        .stat-card .value {
            font-size: 2.8rem;
            font-weight: 800;
            color: var(--primary-dark);
            z-index: 2;
            line-height: 1.1;
        }
        
        .stat-card i {
            align-self: flex-end;
            font-size: 2.5rem;
            color: var(--primary-light);
            opacity: 0.1;
            margin-top: 10px;
            position: absolute;
            right: 20px;
            bottom: 20px;
            z-index: 1;
        }
        
        /* Forms */
        .form-container {
            max-width: 800px;
            margin: 0 auto;
        }
        
        .form-group {
            margin-bottom: 25px;
        }
        
        .form-row {
            display: flex;
            gap: 25px;
            margin-bottom: 20px;
        }
        
        .form-row .form-group {
            flex: 1;
            margin-bottom: 0;
        }
        
        label {
            display: block;
            margin-bottom: 10px;
            font-weight: 600;
            color: var(--text-dark);
            font-size: 0.95rem;
        }
        
        .form-control {
            width: 100%;
            padding: 0.9rem 1.2rem;
            border: 1px solid var(--border-light);
            border-radius: var(--border-radius-md);
            font-size: 1rem;
            transition: var(--hover-transition);
            background: var(--surface-light);
            color: var(--text-dark);
        }
        
        .form-control:focus {
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(74, 100, 168, 0.15);
            outline: none;
            background: white;
        }

        textarea.form-control {
            min-height: 120px;
            resize: vertical;
        }
        
        /* Buttons */
        .btn {
            padding: 0.8rem 1.6rem;
            border: none;
            border-radius: var(--border-radius-md);
            cursor: pointer;
            font-size: 0.95rem;
            font-weight: 600;
            transition: var(--hover-transition);
            display: inline-flex;
            align-items: center;
            gap: 0.6rem;
            text-decoration: none;
            justify-content: center;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }
        
        .btn-sm {
            padding: 0.6rem 1.2rem;
            font-size: 0.85rem;
            border-radius: var(--border-radius-sm);
        }
        
        .btn-primary {
            background: var(--primary);
            color: var(--surface-light);
        }
        .btn-primary:hover {
            background: var(--primary-dark);
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
            transform: translateY(-1px);
        }
        .btn-primary:active {
            transform: translateY(0);
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }
        
        .btn-success {
            background: var(--secondary);
            color: var(--surface-light);
        }
        .btn-success:hover {
            background: var(--secondary-dark);
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
            transform: translateY(-1px);
        }
        .btn-success:active {
            transform: translateY(0);
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }
        
        .btn-danger {
            background: var(--danger);
            color: var(--surface-light);
        }
        .btn-danger:hover {
            background: var(--danger-dark);
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
            transform: translateY(-1px);
        }
        .btn-danger:active {
            transform: translateY(0);
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }
        
        .btn-warning {
            background: var(--warning);
            color: var(--text-dark);
        }
        .btn-warning:hover {
            background: var(--warning-dark);
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
            transform: translateY(-1px);
        }
        .btn-warning:active {
            transform: translateY(0);
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }
        
        .btn-info {
            background: var(--info);
            color: var(--surface-light);
        }
        .btn-info:hover {
            background: var(--info-dark);
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
            transform: translateY(-1px);
        }
        .btn-info:active {
            transform: translateY(0);
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }
        
        .btn-light {
            background: var(--border-light);
            color: var(--text-medium);
            border: 1px solid var(--border-light);
        }
        .btn-light:hover {
            background: var(--text-light);
            color: var(--text-dark);
            box-shadow: 0 4px 10px rgba(0,0,0,0.05);
            transform: translateY(-1px);
        }
        .btn-light:active {
            transform: translateY(0);
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }
        
        /* Tables */
        table {
            width: 100%;
            border-collapse: collapse;
            border-spacing: 0;
            margin-top: 30px;
            font-size: 0.9rem;
            background: var(--surface-light);
            border-radius: var(--border-radius-lg);
            overflow: hidden;
            box-shadow: var(--card-shadow);
            border: 1px solid var(--border-light);
        }
        
        table th {
            background: var(--background-light);
            font-weight: 600;
            text-align: left;
            padding: 1.15rem 1.5rem;
            color: var(--text-medium);
            border-bottom: 1px solid var(--border-light);
            text-transform: uppercase;
            font-size: 0.8rem;
            letter-spacing: 0.5px;
        }
        
        table td {
            padding: 1rem 1.5rem;
            border-bottom: 1px solid var(--border-light);
            color: var(--text-dark);
        }
        
        table tbody tr:last-child td {
            border-bottom: none;
        }
        
        table tbody tr:hover {
            background-color: rgba(74, 100, 168, 0.03);
        }
        
        .empty-message {
            text-align: center;
            padding: 40px;
            color: var(--text-light);
            font-style: italic;
            font-size: 1rem;
        }
        
        .status {
            padding: 6px 12px;
            border-radius: var(--border-radius-sm);
            font-size: 0.75rem;
            font-weight: 600;
            display: inline-block;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .status-paid {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .status-pending {
            background: #fff3cd;
            color: #85640a;
            border: 1px solid #ffeeba;
        }
        
        .status-overdue {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        /* Modals */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.6);
            justify-content: center;
            align-items: center;
            z-index: 1000;
            opacity: 0;
            transform: scale(0.9);
            animation: modalFadeIn 0.3s forwards;
        }
        
        .modal.show {
            display: flex;
        }
        
        @keyframes modalFadeIn {
            to { opacity: 1; transform: scale(1); }
        }
        
        .modal-content {
            background: var(--surface-light);
            padding: 2.8rem;
            border-radius: var(--border-radius-lg);
            width: 95%;
            max-width: 600px;
            box-shadow: var(--modal-shadow);
            position: relative;
            max-height: 90vh;
            overflow-y: auto;
            transform: translateY(-20px);
            animation: modalSlideDown 0.3s forwards;
        }
        
        /* Specific modal content for profile */
        .modal-profile-content {
            max-width: 800px; /* Wider for client profile */
            padding: 2rem 3rem;
            text-align: center;
        }

        .modal-profile-content .profile-header {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 20px;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 1px solid var(--border-light);
        }

        .modal-profile-content .profile-header img {
            width: 100px;
            height: 100px;
            border-radius: 50%;
            object-fit: cover;
            border: 3px solid var(--primary-light);
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
        }

        .modal-profile-content .profile-header h2 {
            font-size: 2.2rem;
            color: var(--primary-dark);
            margin: 0;
        }

        .modal-profile-content .profile-details {
            text-align: left;
            margin-bottom: 30px;
        }

        .modal-profile-content .profile-details h3 {
            font-size: 1.4rem;
            color: var(--text-dark);
            margin-bottom: 15px;
            border-bottom: 1px dashed var(--border-light);
            padding-bottom: 5px;
        }

        .modal-profile-content .profile-details p {
            margin-bottom: 8px;
            font-size: 1rem;
            color: var(--text-medium);
        }

        .modal-profile-content .profile-details p strong {
            color: var(--text-dark);
        }
        
        @keyframes modalSlideDown {
            to { transform: translateY(0); }
        }
        
        .close-modal {
            position: absolute;
            top: 20px;
            right: 20px;
            font-size: 1.8rem;
            cursor: pointer;
            color: var(--text-light);
            transition: var(--hover-transition);
        }
        
        .close-modal:hover {
            color: var(--text-dark);
            transform: rotate(90deg);
        }
        
        /* Receipt */
        .receipt {
            font-family: 'Poppins', sans-serif;
            padding: 35px;
            border: 2px dashed var(--border-light);
            border-radius: var(--border-radius-lg);
            background: #FDFEFF;
        }
        
        .receipt-header {
            text-align: center;
            margin-bottom: 30px;
            padding-bottom: 25px;
            border-bottom: 1px dashed var(--border-light);
        }

        /* Logo do lobo no recibo */
        .receipt-header .logo-lobo-receipt {
            width: 80px;
            height: auto;
            margin-bottom: 10px;
        }
        
        .receipt-header h2 {
            color: var(--primary-dark);
            margin-bottom: 8px;
            font-size: 1.8rem;
            font-weight: 700;
        }
        
        .receipt-header p {
            font-size: 0.95rem;
            color: var(--text-medium);
        }
        
        .receipt-header h3 {
            margin-top: 15px;
            font-size: 1.5rem;
            color: var(--text-dark);
            border-top: 1px dashed var(--border-light);
            padding-top: 15px;
        }
        
        .receipt-body {
            margin-bottom: 30px;
        }
        
        .receipt-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 15px;
            padding-bottom: 15px;
            border-bottom: 1px dashed var(--border-light);
            font-size: 1rem;
            color: var(--text-dark);
        }
        
        .receipt-item span {
            color: var(--text-medium);
            font-weight: 500;
        }
        
        .receipt-item strong {
            font-weight: 600;
            color: var(--text-dark);
        }
        
        .receipt-footer {
            text-align: center;
            font-size: 0.85rem;
            color: var(--text-medium);
            margin-top: 30px;
            padding-top: 25px;
            border-top: 1px dashed var(--border-light);
        }
        
        .action-buttons {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
        }
        
        .search-container {
            display: flex;
            gap: 15px;
            margin-bottom: 25px;
        }
        
        .search-container input {
            flex: 1;
        }
        
        /* Reset Database Button */
        .reset-database-btn {
            background: rgba(220, 53, 69, 0.08);
            border: 1px solid var(--danger);
            color: var(--danger-dark);
            padding: 0.85rem 1.25rem;
            border-radius: var(--border-radius-md);
            cursor: pointer;
            font-weight: 600;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.6rem;
            width: calc(100% - 50px);
            margin: 25px auto 40px;
            position: sticky;
            bottom: 20px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }
        .reset-database-btn:hover {
            background: rgba(220, 53, 69, 0.15);
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
            transform: translateY(-1px);
        }
        .reset-database-btn:active {
            transform: translateY(0);
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }
        
        /* Toast notifications */
        #toast-container {
            position: fixed;
            bottom: 25px;
            right: 25px;
            z-index: 2000;
            max-width: 380px;
        }
        
        .toast {
            background: var(--surface-light);
            padding: 18px 25px;
            border-radius: var(--border-radius-md);
            box-shadow: 0 8px 20px rgba(0,0,0,0.12);
            margin-bottom: 18px;
            display: flex;
            align-items: center;
            gap: 15px;
            transform: translateX(120%);
            opacity: 0;
            animation: slideIn 0.4s forwards cubic-bezier(0.175, 0.885, 0.32, 1.275), fadeOut 0.3s forwards 3s;
            border: 1px solid var(--border-light);
            font-size: 0.95rem;
            font-weight: 500;
            color: var(--text-dark);
        }
        
        .toast i {
            font-size: 1.5rem;
        }
        
        .toast-success {
            border-left: 5px solid var(--secondary);
        }
        
        .toast-success i {
            color: var(--secondary);
        }
        
        .toast-error {
            border-left: 5px solid var(--danger);
        }
        
        .toast-error i {
            color: var(--danger);
        }
        
        .toast-info {
            border-left: 5px solid var(--info);
        }
        
        .toast-info i {
            color: var(--info);
        }
        
        @keyframes slideIn {
            to { transform: translateX(0); opacity: 1; }
        }
        
        @keyframes fadeOut {
            to { opacity: 0; margin-bottom: -60px; }
        }
        
        /* Help Button & Message */
        .help-btn {
            position: fixed;
            bottom: 25px;
            right: 25px;
            width: 55px;
            height: 55px;
            border-radius: 50%;
            background: var(--info);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            box-shadow: 0 5px 15px rgba(23, 162, 184, 0.3);
            z-index: 99;
            font-size: 1.4rem;
            transition: transform 0.3s ease, background 0.3s ease;
        }
        
        .help-btn:hover {
            transform: scale(1.08) rotate(10deg);
            background: var(--info-dark);
        }
        
        .help-message {
            position: fixed;
            bottom: 90px;
            right: 25px;
            background: var(--surface-light);
            padding: 20px;
            border-radius: var(--border-radius-md);
            box-shadow: var(--card-shadow);
            max-width: 320px;
            display: none;
            z-index: 100;
            animation: fadeIn 0.3s ease;
            border: 1px solid var(--border-light);
        }
        
        .help-message.show {
            display: block;
        }
        
        .help-message h4 {
            margin-bottom: 12px;
            color: var(--info-dark);
            font-size: 1.1rem;
            font-weight: 600;
        }
        
        .help-message p {
            font-size: 0.9rem;
            color: var(--text-medium);
            margin-bottom: 8px;
        }
        
        /* Responsive Design */
        @media (max-width: 1200px) {
            .main-content {
                padding: 30px;
            }
            .header h1 {
                font-size: 2.2rem;
            }
            .stats-container {
                grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
            }
            .card {
                padding: 2rem;
                margin-bottom: 2rem;
            }
            .form-control {
                padding: 0.85rem 1.1rem;
            }
            .btn {
                padding: 0.75rem 1.5rem;
                font-size: 0.9rem;
            }
            table th, table td {
                padding: 1rem 1.4rem;
            }
        }
        
        @media (max-width: 992px) {
            .container {
                flex-direction: column;
            }
            
            .sidebar {
                width: 100%;
                padding: 20px;
                position: static;
                height: auto;
                box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            }
            
            .sidebar-header {
                padding-bottom: 20px;
                margin-bottom: 15px;
            }
            .sidebar-header .logo-lobo {
                width: 120px;
            }
            .sidebar-header h2 {
                font-size: 1.8rem;
            }
            
            .sidebar-menu {
                display: flex;
                flex-wrap: wrap;
                justify-content: center;
                gap: 8px;
                margin-top: 15px;
            }
            
            .sidebar-menu li {
                padding: 12px 18px;
                border-radius: var(--border-radius-md);
                border-left: none;
                font-size: 0.85rem;
            }
            
            .sidebar-menu li.active {
                border-left: none;
                background: rgba(74, 100, 168, 0.25);
            }
            .sidebar-menu li:hover {
                transform: translateX(0);
            }

            .main-content {
                padding: 25px;
            }
            
            .header {
                margin-bottom: 20px;
                padding-bottom: 10px;
                gap: 10px;
            }
            .header h1 {
                font-size: 1.5rem;
            }
            .reset-database-btn {
                position: relative;
                bottom: auto;
                margin: 20px auto 20px;
                width: calc(100% - 30px);
            }
        }

        @media (max-width: 768px) {
            .stats-container {
                grid-template-columns: 1fr;
            }
            .header h1 {
                font-size: 1.3rem;
            }
            table {
                display: block;
                overflow-x: auto;
                white-space: nowrap;
                -webkit-overflow-scrolling: touch;
            }
            table thead, table tbody tr {
                display: table;
                width: 100%;
                table-layout: auto;
            }
            table th, table td {
                min-width: 100px;
                white-space: normal;
            }
            .action-buttons {
                flex-direction: column;
                align-items: stretch;
            }
            .btn {
                width: 100%;
            }
            .search-container {
                flex-direction: column;
            }
            .search-container input, .search-container button {
                width: 100%;
            }
            .modal-content {
                padding: 2rem;
                max-width: 90%;
            }
            .receipt {
                padding: 30px;
            }
            .modal-profile-content {
                padding: 1.5rem;
            }
            .modal-profile-content .profile-header {
                flex-direction: column;
                text-align: center;
            }
            .modal-profile-content .profile-header h2 {
                font-size: 1.8rem;
            }
            .modal-profile-content .profile-details {
                font-size: 0.9rem;
            }
        }

        @media (max-width: 480px) {
            .sidebar-menu li {
                flex-basis: auto;
                width: auto;
                max-width: 100%;
            }
            .sidebar-header .logo-lobo {
                width: 90px;
            }
            .sidebar-header h2 {
                font-size: 1.3rem;
            }
            .main-content {
                padding: 15px;
            }
            .card {
                padding: 1.5rem;
            }
            .stats-container {
                gap: 15px;
            }
            .stat-card {
                padding: 1.2rem;
            }
            .stat-card h3 {
                font-size: 0.9rem;
            }
            .stat-card .value {
                font-size: 1.8rem;
            }
            .stat-card i {
                font-size: 1.5rem;
            }
            .btn {
                font-size: 0.85rem;
                padding: 0.6rem 1.2rem;
            }
            .toast {
                bottom: 10px;
                right: 10px;
                max-width: calc(100% - 20px);
                padding: 12px 15px;
                font-size: 0.8rem;
            }
            .help-btn {
                width: 45px;
                height: 45px;
                font-size: 1.1rem;
                bottom: 10px;
                right: 10px;
            }
            .help-message {
                bottom: 65px;
                right: 10px;
                max-width: calc(100% - 20px);
                padding: 15px;
                font-size: 0.8rem;
            }
            .receipt-header .logo-lobo-receipt {
                width: 70px;
            }
        }
        /* Print Styles for Recibo */
        @media print {
            body * {
                visibility: hidden;
            }
            .modal, .modal-content, .receipt, .receipt * {
                visibility: visible;
            }
            .modal {
                position: absolute;
                left: 0;
                top: 0;
                width: 100%;
                height: auto;
                overflow: visible;
                background: none;
                box-shadow: none;
            }
            .modal-content {
                width: 100%;
                max-width: 100%;
                box-shadow: none;
                border-radius: 0;
                padding: 0;
            }
            .close-modal, .btn-imprimir-recibo, #btn-whatsapp-recibo { /* Hide WhatsApp button too */
                display: none !important;
            }
            .receipt {
                border: none;
                padding: 0;
            }
            .receipt-header .logo-lobo-receipt {
                display: block;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="sidebar">
            <div>
                <div class="sidebar-header">
                    <img src="https://i.imgur.com/yTC64oV.png" alt="WolfCred Logo" class="logo-lobo">
                    <h2>WolfCred</h2>
                    <p>Gestão Financeira Inteligente</p>
                </div>
                <ul class="sidebar-menu">
                    <li class="active" data-tab="dashboard"><i class="fas fa-chart-line"></i> Dashboard</li>
                    <li data-tab="clientes"><i class="fas fa-users"></i> Clientes</li>
                    <li data-tab="novo-cliente"><i class="fas fa-user-plus"></i> Novo Cliente</li>
                    <li data-tab="emprestimos"><i class="fas fa-hand-holding-usd"></i> Empréstimos</li>
                    <li data-tab="novo-emprestimo"><i class="fas fa-file-invoice-dollar"></i> Novo Empréstimo</li>
                    <li data-tab="pagamentos"><i class="fas fa-file-invoice"></i> Pagamentos</li>
                    <li data-tab="registrar-pagamento"><i class="fas fa-money-check"></i> Registrar Pagamento</li>
                    <li data-tab="observacoes"><i class="fas fa-comment-dots"></i> Observações</li>
                </ul>
            </div>

            <button class="reset-database-btn" id="btn-reset-db">
                <i class="fas fa-trash-restore"></i> Resetar Base de Dados
            </button>
        </div>

        <div class="main-content">
            <div id="dashboard" class="tab-content active">
                <div class="header">
                    <h1><i class="fas fa-chart-line"></i> Dashboard</h1>
                    <div class="action-buttons">
                        <button class="btn btn-info" id="btn-export-data">
                            <i class="fas fa-file-export"></i> Exportar Dados
                        </button>
                        <button class="btn btn-warning" id="btn-generate-report">
                            <i class="fas fa-file-alt"></i> Gerar Relatório
                        </button>
                    </div>
                </div>

                <div class="stats-container">
                    <div class="stat-card">
                        <h3>Total Clientes</h3>
                        <div class="value" id="total-clientes">0</div>
                        <i class="fas fa-users"></i>
                    </div>
                    <div class="stat-card">
                        <h3>Empréstimos Ativos</h3>
                        <div class="value" id="total-emprestimos">0</div>
                        <i class="fas fa-hand-holding-usd"></i>
                    </div>
                    <div class="stat-card">
                        <h3>Pagamentos Hoje</h3>
                        <div class="value" id="pagamentos-hoje">0</div>
                        <i class="fas fa-calendar-day"></i>
                    </div>
                    <div class="stat-card" id="card-valor-pendente">
                        <h3>Valor Pendente</h3>
                        <div class="value" id="valor-pendente">R$ 0,00</div>
                        <i class="fas fa-exclamation-circle"></i>
                    </div>
                    <div class="stat-card">
                        <h3>Pagamentos Atrasados</h3>
                        <div class="value" id="pagamentos-atrasados">0</div>
                        <i class="fas fa-clock"></i>
                    </div>
                    <div class="stat-card">
                        <h3>Valor Total Pago</h3>
                        <div class="value" id="valor-total-pago">R$ 0,00</div>
                        <i class="fas fa-check-circle"></i>
                    </div>
                </div>

                <div class="card">
                    <h2 style="margin-bottom: 25px; color: var(--text-dark);">Últimos Empréstimos Registrados</h2>
                    <table>
                        <thead>
                            <tr>
                                <th>Cliente</th>
                                <th>Valor</th>
                                <th>Parcelas</th>
                                <th>Data</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody id="ultimos-emprestimos">
                            <tr>
                                <td colspan="5" class="empty-message">Nenhum empréstimo recente.</td>
                            </tr>
                        </tbody>
                    </table>
                </div>

                <div class="card">
                    <h2 style="margin-bottom: 25px; color: var(--text-dark);">Últimos Pagamentos Registrados</h2>
                    <table>
                        <thead>
                            <tr>
                                <th>Cliente</th>
                                <th>Valor</th>
                                <th>Data Pagamento</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody id="ultimos-pagamentos">
                            <tr>
                                <td colspan="4" class="empty-message">Nenhum pagamento registrado</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <div id="clientes" class="tab-content">
                <div class="header">
                    <h1><i class="fas fa-users"></i> Clientes</h1>
                    <button class="btn btn-success" id="btnNovoCliente">
                        <i class="fas fa-user-plus"></i> Adicionar Cliente
                    </button>
                </div>

                <div class="search-container">
                    <input type="text" class="form-control" id="search-client" placeholder="Pesquisar por nome ou CPF...">
                    <button class="btn btn-primary" id="btn-search-client">
                        <i class="fas fa-search"></i> Pesquisar
                    </button>
                </div>

                <div class="card">
                    <table>
                        <thead>
                            <tr>
                                <th>Nome</th>
                                <th>CPF</th>
                                <th>Telefone</th>
                                <th>Ações</th>
                            </tr>
                        </thead>
                        <tbody id="lista-clientes">
                            <tr>
                                <td colspan="4" class="empty-message">Nenhum cliente cadastrado</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <div id="novo-cliente" class="tab-content">
                <div class="header">
                    <h1><i class="fas fa-user-plus"></i> Novo Cliente</h1>
                </div>

                <div class="card">
                    <form id="form-cliente" class="form-container">
                        <div class="form-row">
                            <div class="form-group">
                                <label for="nome-cliente">Nome Completo <span style="color: var(--danger);">*</span></label>
                                <input type="text" class="form-control" id="nome-cliente" required>
                            </div>
                            <div class="form-group">
                                <label for="cpf-cliente">CPF <span style="color: var(--danger);">*</span></label>
                                <input type="text" class="form-control" id="cpf-cliente" required maxlength="14" placeholder="000.000.000-00">
                            </div>
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <label for="telefone-cliente">Telefone <span style="color: var(--danger);">*</span></label>
                                <input type="tel" class="form-control" id="telefone-cliente" required maxlength="15" placeholder="(00) 00000-0000">
                            </div>
                            <div class="form-group">
                                <label for="email-cliente">E-mail</label>
                                <input type="email" class="form-control" id="email-cliente" placeholder="exemplo@email.com">
                            </div>
                        </div>

                        <div class="form-group">
                            <label for="endereco-cliente">Endereço</label>
                            <input type="text" class="form-control" id="endereco-cliente" placeholder="Rua, número, bairro, cidade, estado">
                        </div>

                        <div class="form-group">
                            <label for="foto-cliente">Foto do Cliente</label>
                            <input type="file" class="form-control" id="foto-cliente" accept="image/*">
                            <div id="foto-preview" style="margin-top: 10px; text-align: center;">
                                <img src="https://via.placeholder.com/100?text=Sem+Foto" alt="Preview da Foto" style="max-width: 100px; max-height: 100px; border-radius: 5px; border: 1px solid var(--border-light);">
                            </div>
                        </div>

                        <hr style="margin: 30px 0; border-color: var(--border-light);">
                        <h3>Contatos de Emergência (Até 3)</h3>

                        <div class="form-row">
                            <div class="form-group">
                                <label for="contato-emergencia-1-nome">Nome Contato 1</label>
                                <input type="text" class="form-control" id="contato-emergencia-1-nome">
                            </div>
                            <div class="form-group">
                                <label for="contato-emergencia-1-cpf">CPF Contato 1</label>
                                <input type="text" class="form-control" id="contato-emergencia-1-cpf" maxlength="14" placeholder="000.000.000-00">
                            </div>
                            <div class="form-group">
                                <label for="contato-emergencia-1-telefone">Telefone Contato 1</label>
                                <input type="tel" class="form-control" id="contato-emergencia-1-telefone" maxlength="15" placeholder="(00) 00000-0000">
                            </div>
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <label for="contato-emergencia-2-nome">Nome Contato 2</label>
                                <input type="text" class="form-control" id="contato-emergencia-2-nome">
                            </div>
                            <div class="form-group">
                                <label for="contato-emergencia-2-cpf">CPF Contato 2</label>
                                <input type="text" class="form-control" id="contato-emergencia-2-cpf" maxlength="14" placeholder="000.000.000-00">
                            </div>
                            <div class="form-group">
                                <label for="contato-emergencia-2-telefone">Telefone Contato 2</label>
                                <input type="tel" class="form-control" id="contato-emergencia-2-telefone" maxlength="15" placeholder="(00) 00000-0000">
                            </div>
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <label for="contato-emergencia-3-nome">Nome Contato 3</label>
                                <input type="text" class="form-control" id="contato-emergencia-3-nome">
                            </div>
                            <div class="form-group">
                                <label for="contato-emergencia-3-cpf">CPF Contato 3</label>
                                <input type="text" class="form-control" id="contato-emergencia-3-cpf" maxlength="14" placeholder="000.000.000-00">
                            </div>
                            <div class="form-group">
                                <label for="contato-emergencia-3-telefone">Telefone Contato 3</label>
                                <input type="tel" class="form-control" id="contato-emergencia-3-telefone" maxlength="15" placeholder="(00) 00000-0000">
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label for="observacao-cliente">Observação Inicial do Cliente</label>
                            <textarea class="form-control" id="observacao-cliente" rows="3" placeholder="Ex: Cliente tem restrição de horário para contato, preferência de pagamento."></textarea>
                        </div>


                        <div class="form-group" style="margin-top: 30px; text-align: right;">
                            <button type="button" class="btn btn-light" id="btn-cancelar-cliente">
                                <i class="fas fa-times"></i> Cancelar
                            </button>
                            <button type="submit" class="btn btn-success">
                                <i class="fas fa-save"></i> Salvar Cliente
                            </button>
                        </div>
                    </form>
                </div>
            </div>

            <div id="emprestimos" class="tab-content">
                <div class="header">
                    <h1><i class="fas fa-hand-holding-usd"></i> Empréstimos</h1>
                    <button class="btn btn-success" id="btnNovoEmprestimo">
                        <i class="fas fa-file-invoice-dollar"></i> Registrar Empréstimo
                    </button>
                </div>

                <div class="card">
                    <table>
                        <thead>
                            <tr>
                                <th>Cliente</th>
                                <th>Valor Original</th>
                                <th>Parcelas</th>
                                <th>Taxa Juros</th>
                                <th>Frequência</th>
                                <th>Data</th>
                                <th>Ações</th>
                            </tr>
                        </thead>
                        <tbody id="lista-emprestimos">
                            <tr>
                                <td colspan="7" class="empty-message">Nenhum empréstimo registrado</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <div id="novo-emprestimo" class="tab-content">
                <div class="header">
                    <h1><i class="fas fa-file-invoice-dollar"></i> Novo Empréstimo</h1>
                </div>

                <div class="card">
                    <form id="form-emprestimo" class="form-container">
                        <div class="form-group">
                            <label for="cliente-emprestimo">Cliente <span style="color: var(--danger);">*</span></label>
                            <select class="form-control" id="cliente-emprestimo" required>
                                <option value="">Selecione um cliente</option>
                            </select>
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <label for="valor-emprestimo">Valor do Empréstimo (R$) <span style="color: var(--danger);">*</span></label>
                                <input type="number" class="form-control" id="valor-emprestimo" step="0.01" min="0" required>
                            </div>
                            <div class="form-group">
                                <label for="taxa-emprestimo">Taxa de Juros (% a.m.) <span style="color: var(--danger);">*</span></label>
                                <input type="number" class="form-control" id="taxa-emprestimo" step="0.1" min="0" required>
                            </div>
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <label for="parcelas-emprestimo">Número de Parcelas <span style="color: var(--danger);">*</span></label>
                                <input type="number" class="form-control" id="parcelas-emprestimo" min="1" required>
                            </div>
                            <div class="form-group">
                                <label for="frequencia-pagamento">Frequência de Pagamento <span style="color: var(--danger);">*</span></label>
                                <select class="form-control" id="frequencia-pagamento" required>
                                    <option value="">Selecione a frequência</option>
                                    <option value="Mensal">Mensal</option>
                                    <option value="Quinzenal">Quinzenal</option>
                                    <option value="Semanal">Semanal</option>
                                    <option value="Diária">Diária</option>
                                </select>
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label for="data-emprestimo">Data do Empréstimo <span style="color: var(--danger);">*</span></label>
                            <input type="date" class="form-control" id="data-emprestimo" required>
                        </div>

                        <div class="form-group">
                            <label for="valor-parcela">Valor da Parcela Estimado</label>
                            <input type="text" class="form-control" id="valor-parcela" readonly placeholder="Calculado automaticamente">
                        </div>

                        <div class="form-group" style="margin-top: 30px; text-align: right;">
                            <button type="button" class="btn btn-light" id="btn-cancelar-emprestimo">
                                <i class="fas fa-times"></i> Cancelar
                            </button>
                            <button type="submit" class="btn btn-success">
                                <i class="fas fa-save"></i> Registrar Empréstimo
                            </button>
                        </div>
                    </form>
                </div>
            </div>

            <div id="pagamentos" class="tab-content">
                <div class="header">
                    <h1><i class="fas fa-file-invoice"></i> Pagamentos</h1>
                    <div class="action-buttons">
                        <select class="form-control" id="filter-status" style="width: 180px;">
                            <option value="all">Todos os Status</option>
                            <option value="paid">Pagos</option>
                            <option value="pending">Pendentes</option>
                            <option value="overdue">Atrasados</option>
                        </select>
                        <button class="btn btn-primary" id="btn-filter">
                            <i class="fas fa-filter"></i> Filtrar
                        </button>
                        <button class="btn btn-success" id="btnRegistrarPagamento">
                            <i class="fas fa-money-check"></i> Novo Pagamento
                        </button>
                    </div>
                </div>

                <div class="card">
                    <table>
                        <thead>
                            <tr>
                                <th>Cliente</th>
                                <th>Valor Empréstimo</th>
                                <th>Parcela</th>
                                <th>Valor Parcela</th>
                                <th>Vencimento</th>
                                <th>Status</th>
                                <th>Ações</th>
                            </tr>
                        </thead>
                        <tbody id="lista-pagamentos">
                            <tr>
                                <td colspan="7" class="empty-message">Nenhum pagamento registrado</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <div id="registrar-pagamento" class="tab-content">
                <div class="header">
                    <h1><i class="fas fa-money-check"></i> Registrar Pagamento</h1>
                </div>

                <div class="card">
                    <form id="form-pagamento" class="form-container">
                        <div class="form-group">
                            <label for="emprestimo-pagamento">Empréstimo <span style="color: var(--danger);">*</span></label>
                            <select class="form-control" id="emprestimo-pagamento" required>
                                <option value="">Selecione um empréstimo</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label for="parcela-pagamento">Parcela <span style="color: var(--danger);">*</span></label>
                            <select class="form-control" id="parcela-pagamento" required>
                                <option value="">Selecione uma parcela</option>
                            </select>
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <label for="valor-pagamento">Valor do Pagamento (R$) <span style="color: var(--danger);">*</span></label>
                                <input type="number" class="form-control" id="valor-pagamento" step="0.01" min="0" required>
                            </div>
                            <div class="form-group">
                                <label for="data-pagamento">Data do Pagamento <span style="color: var(--danger);">*</span></label>
                                <input type="date" class="form-control" id="data-pagamento" required>
                            </div>
                        </div>

                        <div class="form-group">
                            <label for="forma-pagamento">Forma de Pagamento <span style="color: var(--danger);">*</span></label>
                            <select class="form-control" id="forma-pagamento" required>
                                <option value="">Selecione</option>
                                <option value="Dinheiro">Dinheiro</option>
                                <option value="Cartão">Cartão</option>
                                <option value="Transferência">Transferência Bancária</option>
                                <option value="Cheque">Cheque</option>
                                <option value="Pix">Pix</option>
                            </select>
                        </div>

                        <div class="form-group" style="margin-top: 30px; text-align: right;">
                            <button type="button" class="btn btn-light" id="btn-cancelar-pagamento">
                                <i class="fas fa-times"></i> Cancelar
                            </button>
                            <button type="submit" class="btn btn-success">
                                <i class="fas fa-save"></i> Registrar Pagamento
                            </button>
                        </div>
                    </form>
                </div>
            </div>

            <div id="observacoes" class="tab-content">
                <div class="header">
                    <h1><i class="fas fa-comment-dots"></i> Observações</h1>
                </div>

                <div class="card">
                    <form id="form-observacao" class="form-container">
                        <div class="form-group">
                            <label for="cliente-observacao">Cliente (opcional)</label>
                            <select class="form-control" id="cliente-observacao">
                                <option value="">Observação geral ou selecione um cliente</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="texto-observacao">Texto da Observação <span style="color: var(--danger);">*</span></label>
                            <textarea class="form-control" id="texto-observacao" required rows="5"></textarea>
                        </div>
                        <div class="form-group" style="margin-top: 30px; text-align: right;">
                            <button type="button" class="btn btn-light" id="btn-cancelar-observacao">
                                <i class="fas fa-times"></i> Cancelar
                            </button>
                            <button type="submit" class="btn btn-primary">
                                <i class="fas fa-plus-circle"></i> Adicionar Observação
                            </button>
                        </div>
                    </form>
                </div>

                <div class="card">
                    <h2 style="margin-bottom: 25px; color: var(--text-dark);">Lista de Observações</h2>
                    <table>
                        <thead>
                            <tr>
                                <th>Cliente</th>
                                <th>Observação</th>
                                <th>Data</th>
                                <th>Ações</th>
                            </tr>
                        </thead>
                        <tbody id="lista-observacoes">
                            <tr>
                                <td colspan="4" class="empty-message">Nenhuma observação registrada.</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <div class="modal" id="modal-recibo">
        <div class="modal-content" data-client-id="" data-loan-id="" data-payment-id="" data-receipt-type=""> 
            <span class="close-modal" id="btn-fechar-recibo">&times;</span>
            <div class="receipt">
                <div class="receipt-header">
                    <img src="https://i.imgur.com/yTC64oV.png" alt="WolfCred Logo" class="logo-lobo-receipt">
                    <h2>WolfCred</h2>
                    <p>Gestão Financeira Inteligente</p>
                    <h3 id="recibo-tipo">RECIBO</h3>
                </div>
                <div class="receipt-body">
                    <div class="receipt-item">
                        <span>Número do Recibo:</span>
                        <strong id="recibo-numero">000001</strong>
                    </div>
                    <div class="receipt-item">
                        <span>Data da Transação:</span>
                        <strong id="recibo-data">15/07/2023</strong>
                    </div>
                    <div class="receipt-item">
                        <span>Cliente:</span>
                        <strong id="recibo-cliente">João da Silva</strong>
                    </div>
                    <div class="receipt-item">
                        <span>CPF:</span>
                        <strong id="recibo-cpf">123.456.789-00</strong>
                    </div>
                    <div class="receipt-item">
                        <span>Valor:</span>
                        <strong id="recibo-valor">R$ 1.200,00</strong>
                    </div>
                    <div class="receipt-item">
                        <span>Descrição:</span>
                        <strong id="recibo-descricao">Pagamento da parcela 1/12</strong>
                    </div>
                    <div class="receipt-item">
                        <span>Forma de Pagamento:</span>
                        <strong id="recibo-forma">Dinheiro</strong>
                    </div>
                </div>
                <div class="receipt-footer">
                    <p>Este documento serve como comprovante oficial.</p>
                    <p>WolfCred &copy; 2025 - Todos os direitos reservados</p>
                </div>
            </div>
            <div style="text-align: center; margin-top: 25px;">
                <button class="btn btn-primary" id="btn-imprimir-recibo">
                    <i class="fas fa-print"></i> Imprimir Recibo
                </button>
                <button class="btn btn-success" id="btn-whatsapp-recibo">
                    <i class="fab fa-whatsapp"></i> Enviar WhatsApp
                </button>
            </div>
        </div>
    </div>

    <div class="modal" id="modal-perfil-cliente">
        <div class="modal-content modal-profile-content">
            <span class="close-modal" id="btn-fechar-perfil-cliente">&times;</span>
            <div class="profile-header">
                <img src="https://via.placeholder.com/100?text=NF" alt="Foto do Cliente" id="perfil-cliente-foto">
                <h2 id="perfil-cliente-nome">Nome do Cliente</h2>
            </div>
            <div class="profile-details">
                <h3>Dados Pessoais</h3>
                <p><strong>CPF:</strong> <span id="perfil-cliente-cpf"></span></p>
                <p><strong>Telefone:</strong> <span id="perfil-cliente-telefone"></span></p>
                <p><strong>E-mail:</strong> <span id="perfil-cliente-email"></span></p>
                <p><strong>Endereço:</strong> <span id="perfil-cliente-endereco"></span></p>
            </div>

            <div class="profile-details" id="perfil-contatos-emergencia">
                <h3>Contatos de Emergência</h3>
                </div>

            <div class="profile-details">
                <h3>Empréstimos do Cliente</h3>
                <table>
                    <thead>
                        <tr>
                            <th>Valor</th>
                            <th>Parcelas</th>
                            <th>Juros</th>
                            <th>Frequência</th>
                            <th>Data</th>
                        </tr>
                    </thead>
                    <tbody id="perfil-emprestimos-historico">
                        <tr><td colspan="5" class="empty-message">Nenhum empréstimo registrado.</td></tr>
                    </tbody>
                </table>
            </div>

            <div class="profile-details">
                <h3>Histórico de Pagamentos</h3>
                <table>
                    <thead>
                        <tr>
                            <th>Parcela</th>
                            <th>Valor</th>
                            <th>Vencimento</th>
                            <th>Status</th>
                            <th>Data Pgto</th>
                            <th>Forma Pgto</th>
                        </tr>
                    </thead>
                    <tbody id="perfil-pagamentos-historico">
                        <tr><td colspan="6" class="empty-message">Nenhum pagamento registrado.</td></tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>


    <div class="modal" id="modal-confirm-reset">
        <div class="modal-content confirmation-modal">
            <h3><i class="fas fa-exclamation-triangle"></i> Confirmar Reset</h3>
            <p>Tem certeza que deseja apagar **TODOS** os dados do sistema? Esta ação é irreversível.</p>
            <div class="confirmation-buttons">
                <button class="btn btn-danger" id="btn-confirm-reset">
                    <i class="fas fa-trash"></i> Sim, Resetar Tudo
                </button>
                <button class="btn btn-light" id="btn-cancel-reset">
                    <i class="fas fa-times"></i> Cancelar
                </button>
            </div>
        </div>
    </div>

    <div id="toast-container"></div>

    <div class="help-btn" id="help-btn">
        <i class="fas fa-question"></i>
    </div>

    <div class="help-message" id="help-message">
        <h4>Dicas Rápidas</h4>
        <p>1. Use o Dashboard para ter uma visão geral rápida das suas finanças.</p>
        <p>2. Registre novos clientes e empréstimos nas suas respectivas abas.</p>
        <p>3. Filtre pagamentos por status para gerenciar o que está pendente ou atrasado.</p>
        <p>4. Precisa começar do zero? Use o botão "Resetar Base de Dados".</p>
    </div>

    <script>
        // Data storage using localStorage
        const database = {
            clientes: [],
            emprestimos: [],
            pagamentos: [], // This now stores individual installment details
            recibos: [],
            observacoes: [], // New: to store observations
            proximoNumeroRecibo: 1, // For general receipts
            nextInstallmentId: 1, // New: For unique integer installment IDs, starts from 1

            // Helper methods for data retrieval
            getCliente: function(id) {
                return this.clientes.find(c => c.id === id);
            },

            getEmprestimo: function(id) {
                return this.emprestimos.find(e => e.id === id);
            },

            getPagamento: function(id) {
                return this.pagamentos.find(p => p.id === id); 
            },

            getParcelasEmprestimo: function(emprestimoId) {
                return this.pagamentos.filter(p => p.emprestimoId === emprestimoId);
            },

            getParcelasPendentesEmprestimo: function(emprestimoId) {
                return this.pagamentos.filter(p => p.emprestimoId === emprestimoId && p.status === 'pending');
            },

            getPagamentosHoje: function() {
                const hoje = new Date().toISOString().split('T')[0];
                return this.pagamentos.filter(p => p.dataPagamento === hoje && p.status === 'paid');
            },

            getPagamentosAtrasados: function() {
                const hoje = new Date().toISOString().split('T')[0];
                return this.pagamentos.filter(p => p.status === 'pending' && p.dataVencimento < hoje);
            },

            getTotalPendente: function() {
                return this.pagamentos
                    .filter(p => p.status === 'pending' || p.status === 'overdue')
                    .reduce((sum, p) => sum + p.valorRestante, 0); // Sum `valorRestante`
            },

            getTotalPago: function() {
                return this.pagamentos
                    .filter(p => p.status === 'paid')
                    .reduce((sum, p) => sum + p.valorPago, 0);
            },

            // Reset all data in the database
            resetDatabase: function() {
                this.clientes = [];
                this.emprestimos = [];
                this.pagamentos = [];
                this.recibos = [];
                this.observacoes = [];
                this.proximoNumeroRecibo = 1;
                this.nextInstallmentId = 1; 
                localStorage.removeItem('crediControlDB');
            },

            // Save data to localStorage
            saveToLocalStorage: function() {
                const dbCopy = {
                    clientes: this.clientes,
                    emprestimos: this.emprestimos,
                    pagamentos: this.pagamentos,
                    recibos: this.recibos,
                    observacoes: this.observacoes,
                    proximoNumeroRecibo: this.proximoNumeroRecibo,
                    nextInstallmentId: this.nextInstallmentId
                };
                localStorage.setItem('crediControlDB', JSON.stringify(dbCopy));
            },

            // Load data from localStorage
            loadFromLocalStorage: function() {
                const savedDB = localStorage.getItem('crediControlDB');
                if (savedDB) {
                    const parsedDB = JSON.parse(savedDB);
                    this.clientes = parsedDB.clientes || [];
                    this.emprestimos = parsedDB.emprestimos || [];
                    this.pagamentos = parsedDB.pagamentos || [];
                    this.recibos = parsedDB.recibos || [];
                    this.observacoes = parsedDB.observacoes || [];
                    this.proximoNumeroRecibo = parsedDB.proximoNumeroRecibo || 1;
                    this.nextInstallmentId = parsedDB.nextInstallmentId || 1;
                }
            }
        };

        // DOM elements
        const elements = {
            tabs: document.querySelectorAll('.sidebar-menu li'),
            tabContents: document.querySelectorAll('.tab-content'),
            forms: {
                cliente: document.getElementById('form-cliente'),
                emprestimo: document.getElementById('form-emprestimo'),
                pagamento: document.getElementById('form-pagamento'),
                observacao: document.getElementById('form-observacao')
            },
            buttons: {
                novoCliente: document.getElementById('btnNovoCliente'),
                novoEmprestimo: document.getElementById('btnNovoEmprestimo'),
                registrarPagamento: document.getElementById('btnRegistrarPagamento'),
                cancelarCliente: document.getElementById('btn-cancelar-cliente'),
                cancelarEmprestimo: document.getElementById('btn-cancelar-emprestimo'),
                cancelarPagamento: document.getElementById('btn-cancelar-pagamento'),
                cancelarObservacao: document.getElementById('btn-cancelar-observacao'),
                imprimirRecibo: document.getElementById('btn-imprimir-recibo'),
                fecharRecibo: document.getElementById('btn-fechar-recibo'),
                filter: document.getElementById('btn-filter'),
                searchClient: document.getElementById('btn-search-client'),
                resetDB: document.getElementById('btn-reset-db'),
                confirmReset: document.getElementById('btn-confirm-reset'),
                cancelReset: document.getElementById('btn-cancel-reset'),
                exportData: document.getElementById('btn-export-data'),
                generateReport: document.getElementById('btn-generate-report'),
                helpBtn: document.getElementById('help-btn'),
                whatsappRecibo: document.getElementById('btn-whatsapp-recibo'),
                fecharPerfilCliente: document.getElementById('btn-fechar-perfil-cliente')
            },
            selects: {
                clienteEmprestimo: document.getElementById('cliente-emprestimo'),
                frequenciaPagamento: document.getElementById('frequencia-pagamento'),
                emprestimoPagamento: document.getElementById('emprestimo-pagamento'),
                parcelaPagamento: document.getElementById('parcela-pagamento'),
                filterStatus: document.getElementById('filter-status'),
                clienteObservacao: document.getElementById('cliente-observacao')
            },
            lists: {
                clientes: document.getElementById('lista-clientes'),
                emprestimos: document.getElementById('lista-emprestimos'),
                pagamentos: document.getElementById('lista-pagamentos'),
                ultimosPagamentos: document.getElementById('ultimos-pagamentos'),
                ultimosEmprestimos: document.getElementById('ultimos-emprestimos'),
                observacoes: document.getElementById('lista-observacoes')
            },
            dashboard: {
                totalClientes: document.getElementById('total-clientes'),
                totalEmprestimos: document.getElementById('total-emprestimos'),
                pagamentosHoje: document.getElementById('pagamentos-hoje'),
                valorPendente: document.getElementById('valor-pendente'),
                pagamentosAtrasados: document.getElementById('pagamentos-atrasados'),
                valorTotalPago: document.getElementById('valor-total-pago'),
                cardValorPendente: document.getElementById('card-valor-pendente')
            },
            modals: {
                recibo: document.getElementById('modal-recibo'),
                confirmReset: document.getElementById('modal-confirm-reset'),
                perfilCliente: document.getElementById('modal-perfil-cliente')
            },
            profileDetails: {
                foto: document.getElementById('perfil-cliente-foto'),
                nome: document.getElementById('perfil-cliente-nome'),
                cpf: document.getElementById('perfil-cliente-cpf'),
                telefone: document.getElementById('perfil-cliente-telefone'),
                email: document.getElementById('perfil-cliente-email'),
                endereco: document.getElementById('perfil-cliente-endereco'),
                contatosEmergencia: document.getElementById('perfil-contatos-emergencia'),
                emprestimosHistorico: document.getElementById('perfil-emprestimos-historico'),
                pagamentosHistorico: document.getElementById('perfil-pagamentos-historico')
            },
            searchClientInput: document.getElementById('search-client'),
            helpMessage: document.getElementById('help-message'),
            // New inputs
            inputs: {
                fotoCliente: document.getElementById('foto-cliente'),
                fotoPreview: document.getElementById('foto-preview').querySelector('img'),
                contatoEmergencia1Nome: document.getElementById('contato-emergencia-1-nome'),
                contatoEmergencia1Cpf: document.getElementById('contato-emergencia-1-cpf'),
                contatoEmergencia1Telefone: document.getElementById('contato-emergencia-1-telefone'),
                contatoEmergencia2Nome: document.getElementById('contato-emergencia-2-nome'),
                contatoEmergencia2Cpf: document.getElementById('contato-emergencia-2-cpf'),
                contatoEmergencia2Telefone: document.getElementById('contato-emergencia-2-telefone'),
                contatoEmergencia3Nome: document.getElementById('contato-emergencia-3-nome'),
                contatoEmergencia3Cpf: document.getElementById('contato-emergencia-3-cpf'),
                contatoEmergencia3Telefone: document.getElementById('contato-emergencia-3-telefone'),
                textoObservacao: document.getElementById('texto-observacao'),
                observacaoCliente: document.getElementById('observacao-cliente') // New
            }
        };

        // --- Core Functions ---

        // Initialize the system
        function init() {
            database.loadFromLocalStorage();
            setupNavigation();
            setupForms();
            setupButtons();
            setupMasks();
            checkOverduePayments(); // Check and update overdue status on load
            updateUI(); // Initial UI update
        }

        // Switch active tab and update UI
        function switchTab(tabId) {
            elements.tabs.forEach(tab => tab.classList.remove('active'));
            elements.tabContents.forEach(c => c.classList.remove('active'));

            document.querySelector(`[data-tab="${tabId}"]`).classList.add('active');
            document.getElementById(tabId).classList.add('active');

            // Reset forms and load data relevant to the tab being opened
            if (tabId === 'novo-cliente') {
                elements.forms.cliente.reset();
                elements.inputs.fotoPreview.src = 'https://via.placeholder.com/100?text=Sem+Foto';
                elements.inputs.fotoCliente.value = ''; 
                elements.inputs.observacaoCliente.value = ''; // Clear client observation
                for (let i = 1; i <= 3; i++) { 
                    elements.inputs[`contatoEmergencia${i}Nome`].value = '';
                    elements.inputs[`contatoEmergencia${i}Cpf`].value = '';
                    elements.inputs[`contatoEmergencia${i}Telefone`].value = '';
                }
                delete elements.forms.cliente.dataset.editId; 
            } else if (tabId === 'novo-emprestimo') {
                elements.forms.emprestimo.reset();
                document.getElementById('valor-parcela').value = '';
                loadClientsForLoan();
            } else if (tabId === 'registrar-pagamento') {
                elements.forms.pagamento.reset();
                elements.selects.parcelaPagamento.innerHTML = '<option value="">Selecione uma parcela</option>';
                document.getElementById('valor-pagamento').value = '';
                loadLoansForPayment();
            } else if (tabId === 'observacoes') {
                elements.forms.observacao.reset();
                elements.selects.clienteObservacao.value = '';
                loadClientsForObservations();
            }
            updateUI(); // Always refresh UI on tab change
        }

        // Setup navigation click listeners
        function setupNavigation() {
            elements.tabs.forEach(tab => {
                tab.addEventListener('click', function() {
                    const tabId = this.getAttribute('data-tab');
                    switchTab(tabId);
                });
            });
        }

        // Setup form submission and input listeners
        function setupForms() {
            elements.forms.cliente.addEventListener('submit', function(e) {
                e.preventDefault();
                registerClient();
            });

            elements.forms.emprestimo.addEventListener('submit', function(e) {
                e.preventDefault();
                registerLoan();
            });

            elements.forms.pagamento.addEventListener('submit', function(e) {
                e.preventDefault();
                registerPayment();
            });

            elements.forms.observacao.addEventListener('submit', function(e) {
                e.preventDefault();
                addObservation();
            });

            // Auto-calculate installment value
            document.getElementById('valor-emprestimo').addEventListener('input', calculateInstallmentValue);
            document.getElementById('taxa-emprestimo').addEventListener('input', calculateInstallmentValue);
            document.getElementById('parcelas-emprestimo').addEventListener('input', calculateInstallmentValue);
            elements.selects.frequenciaPagamento.addEventListener('change', calculateInstallmentValue); 

            // Update installment options when loan is selected for payment
            elements.selects.emprestimoPagamento.addEventListener('change', updateParcelasForPayment);

            elements.selects.parcelaPagamento.addEventListener('change', function() {
                const selectedParcelaId = parseInt(this.value); 
                console.log('Selected Parcela ID in dropdown change:', selectedParcelaId); 
                const parcela = database.getPagamento(selectedParcelaId); 
                console.log('Found Parcela in dropdown change:', parcela); 
                if (parcela) {
                    // Set min/max for valor-pagamento based on remaining amount
                    document.getElementById('valor-pagamento').min = 0.01;
                    document.getElementById('valor-pagamento').max = parcela.valorRestante.toFixed(2);
                    document.getElementById('valor-pagamento').value = parcela.valorRestante.toFixed(2);
                }
            });
        }

        // Setup button click listeners
        function setupButtons() {
            elements.buttons.novoCliente.addEventListener('click', () => switchTab('novo-cliente'));
            elements.buttons.novoEmprestimo.addEventListener('click', () => switchTab('novo-emprestimo'));
            elements.buttons.registrarPagamento.addEventListener('click', () => switchTab('registrar-pagamento'));

            elements.buttons.cancelarCliente.addEventListener('click', () => {
                elements.forms.cliente.reset();
                delete elements.forms.cliente.dataset.editId; 
                elements.inputs.fotoPreview.src = 'https://via.placeholder.com/100?text=Sem+Foto'; 
                elements.inputs.fotoCliente.value = ''; 
                elements.inputs.observacaoCliente.value = ''; 
                for (let i = 1; i <= 3; i++) { 
                    elements.inputs[`contatoEmergencia${i}Nome`].value = '';
                    elements.inputs[`contatoEmergencia${i}Cpf`].value = '';
                    elements.inputs[`contatoEmergencia${i}Telefone`].value = '';
                }
                switchTab('clientes');
            });
            elements.buttons.cancelarEmprestimo.addEventListener('click', () => {
                elements.forms.emprestimo.reset();
                document.getElementById('valor-parcela').value = ''; 
                switchTab('emprestimos');
            });
            elements.buttons.cancelarPagamento.addEventListener('click', () => {
                elements.forms.pagamento.reset();
                elements.selects.parcelaPagamento.innerHTML = '<option value="">Selecione uma parcela</option>'; 
                document.getElementById('valor-pagamento').value = ''; 
                switchTab('pagamentos');
            });
            elements.buttons.cancelarObservacao.addEventListener('click', () => { 
                elements.forms.observacao.reset();
                elements.selects.clienteObservacao.value = '';
                switchTab('observacoes');
            });

            elements.buttons.fecharRecibo.addEventListener('click', () => elements.modals.recibo.classList.remove('show'));
            elements.buttons.imprimirRecibo.addEventListener('click', () => window.print());
            elements.buttons.whatsappRecibo.addEventListener('click', shareReceiptViaWhatsApp); 

            // New button for closing client profile modal
            elements.buttons.fecharPerfilCliente.addEventListener('click', () => elements.modals.perfilCliente.classList.remove('show'));

            elements.buttons.filter.addEventListener('click', filterPayments);
            elements.buttons.searchClient.addEventListener('click', filterClients);
            elements.searchClientInput.addEventListener('keyup', filterClients);

            elements.buttons.resetDB.addEventListener('click', () => elements.modals.confirmReset.classList.add('show'));
            elements.buttons.confirmReset.addEventListener('click', () => {
                database.resetDatabase();
                updateUI();
                elements.modals.confirmReset.classList.remove('show');
                showToast('Todos os dados foram resetados com sucesso!', 'success');
            });
            elements.buttons.cancelReset.addEventListener('click', () => elements.modals.confirmReset.classList.remove('show'));

            elements.buttons.exportData.addEventListener('click', exportData);
            elements.buttons.generateReport.addEventListener('click', generateReport);

            elements.buttons.helpBtn.addEventListener('click', () => elements.helpMessage.classList.toggle('show'));
        }

        // Apply input masks
        function setupMasks() {
            document.getElementById('cpf-cliente').addEventListener('input', function(e) {
                let value = e.target.value.replace(/\D/g, '');
                if (value.length > 11) value = value.slice(0, 11);

                if (value.length > 9) {
                    value = value.replace(/(\d{3})(\d{3})(\d{3})(\d{2})/, '$1.$2.$3-$4');
                } else if (value.length > 6) {
                    value = value.replace(/(\d{3})(\d{3})(\d{1,3})/, '$1.$2.$3');
                } else if (value.length > 3) {
                    value = value.replace(/(\d{3})(\d{1,3})/, '$1.$2');
                }
                e.target.value = value;
            });

            document.getElementById('telefone-cliente').addEventListener('input', function(e) {
                let value = e.target.value.replace(/\D/g, '');
                if (value.length > 11) value = value.slice(0, 11);

                if (value.length > 10) { // (XX) XXXXX-XXXX
                    value = value.replace(/(\d{2})(\d{5})(\d{4})/, '($1) $2-$3');
                } else if (value.length > 6) { // (XX) XXXX-XXXX
                    value = value.replace(/(\d{2})(\d{4})(\d{0,4})/, '($1) $2-$3');
                } else if (value.length > 2) { // (XX) XXXX
                    value = value.replace(/(\d{2})(\d{0,5})/, '($1) $2');
                }
                e.target.value = value;
            });

            // Masks for emergency contacts
            elements.inputs.contatoEmergencia1Cpf.addEventListener('input', function(e) {
                let value = e.target.value.replace(/\D/g, '');
                if (value.length > 11) value = value.slice(0, 11);
                if (value.length > 9) { value = value.replace(/(\d{3})(\d{3})(\d{3})(\d{2})/, '$1.$2.$3-$4'); }
                else if (value.length > 6) { value = value.replace(/(\d{3})(\d{3})(\d{1,3})/, '$1.$2.$3'); }
                else if (value.length > 3) { value = value.replace(/(\d{3})(\d{1,3})/, '$1.$2'); }
                e.target.value = value;
            });
            elements.inputs.contatoEmergencia1Telefone.addEventListener('input', function(e) {
                let value = e.target.value.replace(/\D/g, '');
                if (value.length > 11) value = value.slice(0, 11);
                if (value.length > 10) { value = value.replace(/(\d{2})(\d{5})(\d{4})/, '($1) $2-$3'); }
                else if (value.length > 6) { value = value.replace(/(\d{2})(\d{4})(\d{0,4})/, '($1) $2-$3'); }
                else if (value.length > 2) { value = value.replace(/(\d{2})(\d{0,5})/, '($1) $2'); }
                e.target.value = value;
            });

            elements.inputs.contatoEmergencia2Cpf.addEventListener('input', function(e) {
                let value = e.target.value.replace(/\D/g, '');
                if (value.length > 11) value = value.slice(0, 11);
                if (value.length > 9) { value = value.replace(/(\d{3})(\d{3})(\d{3})(\d{2})/, '$1.$2.$3-$4'); }
                else if (value.length > 6) { value = value.replace(/(\d{3})(\d{3})(\d{1,3})/, '$1.$2.$3'); }
                else if (value.length > 3) { value = value.replace(/(\d{3})(\d{1,3})/, '$1.$2'); }
                e.target.value = value;
            });
            elements.inputs.contatoEmergencia2Telefone.addEventListener('input', function(e) {
                let value = e.target.value.replace(/\D/g, '');
                if (value.length > 11) value = value.slice(0, 11);
                if (value.length > 10) { value = value.replace(/(\d{2})(\d{5})(\d{4})/, '($1) $2-$3'); }
                else if (value.length > 6) { value = value.replace(/(\d{2})(\d{4})(\d{0,4})/, '($1) $2-$3'); }
                else if (value.length > 2) { value = value.replace(/(\d{2})(\d{0,5})/, '($1) $2'); }
                e.target.value = value;
            });

            elements.inputs.contatoEmergencia3Cpf.addEventListener('input', function(e) {
                let value = e.target.value.replace(/\D/g, '');
                if (value.length > 11) value = value.slice(0, 11);
                if (value.length > 9) { value = value.replace(/(\d{3})(\d{3})(\d{3})(\d{2})/, '$1.$2.$3-$4'); }
                else if (value.length > 6) { value = value.replace(/(\d{3})(\d{3})(\d{1,3})/, '$1.$2.$3'); }
                else if (value.length > 3) { value = value.replace(/(\d{3})(\d{1,3})/, '$1.$2'); }
                e.target.value = value;
            });
            elements.inputs.contatoEmergencia3Telefone.addEventListener('input', function(e) {
                let value = e.target.value.replace(/\D/g, '');
                if (value.length > 11) value = value.slice(0, 11);
                if (value.length > 10) { value = value.replace(/(\d{2})(\d{5})(\d{4})/, '($1) $2-$3'); }
                else if (value.length > 6) { value = value.replace(/(\d{2})(\d{4})(\d{0,4})/, '($1) $2-$3'); }
                else if (value.length > 2) { value = value.replace(/(\d{2})(\d{0,5})/, '($1) $2'); }
                e.target.value = value;
            });


            // Photo preview
            elements.inputs.fotoCliente.addEventListener('change', function(e) {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        elements.inputs.fotoPreview.src = e.target.result;
                    };
                    reader.readAsDataURL(file);
                } else {
                    elements.inputs.fotoPreview.src = 'https://via.placeholder.com/100?text=Sem+Foto';
                }
            });
        }

        // --- CRUD Operations ---

        // Register a new client
        function registerClient() {
            const nome = document.getElementById('nome-cliente').value.trim();
            const cpf = document.getElementById('cpf-cliente').value.replace(/\D/g, '');
            const telefone = document.getElementById('telefone-cliente').value.replace(/\D/g, '');
            const email = document.getElementById('email-cliente').value.trim();
            const endereco = document.getElementById('endereco-cliente').value.trim();
            const fotoFile = elements.inputs.fotoCliente.files[0]; 
            const observacaoInicial = elements.inputs.observacaoCliente.value.trim(); // New: get initial observation

            // Collect emergency contacts
            const contatosEmergencia = [];
            for (let i = 1; i <= 3; i++) {
                const nomeContato = elements.inputs[`contatoEmergencia${i}Nome`].value.trim();
                const cpfContato = elements.inputs[`contatoEmergencia${i}Cpf`].value.replace(/\D/g, '');
                const telefoneContato = elements.inputs[`contatoEmergencia${i}Telefone`].value.replace(/\D/g, '');

                if (nomeContato || cpfContato || telefoneContato) { 
                    if (!nomeContato || cpfContato.length !== 11 || telefoneContato.length < 10) {
                        showToast(`Preencha Nome, CPF (11 dígitos) e Telefone (mín. 10 dígitos) corretamente para o Contato de Emergência ${i}, ou deixe todos vazios.`, 'error');
                        return;
                    }
                    contatosEmergencia.push({
                        nome: nomeContato,
                        cpf: cpfContato,
                        telefone: telefoneContato
                    });
                }
            }

            if (!nome || nome.length < 3) {
                showToast('O nome completo é obrigatório e deve ter ao menos 3 caracteres.', 'error');
                return;
            }
            if (cpf.length !== 11) {
                showToast('CPF inválido. Deve conter exatamente 11 dígitos.', 'error');
                return;
            }
            const isEditingId = elements.forms.cliente.dataset.editId ? parseInt(elements.forms.cliente.dataset.editId) : null;
            if (database.clientes.some(c => c.cpf === cpf && c.id !== isEditingId)) {
                showToast('Já existe um cliente com este CPF cadastrado.', 'error');
                return;
            }
            if (telefone.length < 10) {
                showToast('Telefone inválido. Deve conter DDD e número (Ex: 31987654321).', 'error');
                return;
            }
            if (email && !/\S+@\S+\.\S+/.test(email)) {
                showToast('Formato de e-mail inválido.', 'error');
                return;
            }

            let successMessage = 'Cliente cadastrado com sucesso!';

            const saveClientData = (base64Foto = '') => {
                let clientId;
                if (isEditingId) {
                    const clientIndex = database.clientes.findIndex(c => c.id === isEditingId);
                    if (clientIndex > -1) {
                        clientId = isEditingId;
                        database.clientes[clientIndex] = {
                            id: clientId,
                            nome, cpf, telefone, email, endereco,
                            foto: base64Foto || database.clientes[clientIndex].foto || '', 
                            contatosEmergencia
                        };
                        successMessage = 'Cliente atualizado com sucesso!';
                    }
                } else {
                    clientId = Date.now(); // Generate ID for new client
                    database.clientes.push({
                        id: clientId,
                        nome, cpf, telefone, email, endereco,
                        foto: base64Foto,
                        contatosEmergencia
                    });
                }

                // If there's an initial observation, add it
                if (observacaoInicial) {
                    database.observacoes.push({
                        id: Date.now() + Math.random(), // Unique ID for observation
                        clienteId: clientId,
                        texto: `Observação inicial: ${observacaoInicial}`,
                        data: new Date().toISOString().split('T')[0]
                    });
                }


                database.saveToLocalStorage();
                elements.forms.cliente.reset();
                elements.inputs.fotoPreview.src = 'https://via.placeholder.com/100?text=Sem+Foto'; 
                elements.inputs.fotoCliente.value = ''; 
                elements.inputs.observacaoCliente.value = ''; // Clear initial observation field
                for (let i = 1; i <= 3; i++) { 
                    elements.inputs[`contatoEmergencia${i}Nome`].value = '';
                    elements.inputs[`contatoEmergencia${i}Cpf`].value = '';
                    elements.inputs[`contatoEmergencia${i}Telefone`].value = '';
                }
                delete elements.forms.cliente.dataset.editId; // Clear edit ID after save

                switchTab('clientes');
                showToast(successMessage, 'success');
            };

            if (fotoFile) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    saveClientData(e.target.result);
                };
                reader.readAsDataURL(fotoFile);
            } else {
                saveClientData(elements.inputs.fotoPreview.src.startsWith('data:image') ? elements.inputs.fotoPreview.src : '');
            }
        }

        // Register a new loan
        function registerLoan() {
            const clienteId = parseInt(elements.selects.clienteEmprestimo.value);
            const valor = parseFloat(document.getElementById('valor-emprestimo').value);
            const taxa = parseFloat(document.getElementById('taxa-emprestimo').value);
            const parcelas = parseInt(document.getElementById('parcelas-emprestimo').value);
            const frequencia = elements.selects.frequenciaPagamento.value; 
            const data = document.getElementById('data-emprestimo').value;
            const valorParcelaFormatted = document.getElementById('valor-parcela').value;
            const valorParcela = parseFloat(valorParcelaFormatted.replace('R$ ', '').replace(/\./g, '').replace(',', '.')) || 0;

            if (!clienteId) {
                showToast('Selecione um cliente para o empréstimo.', 'error');
                return;
            }
            if (valor <= 0 || isNaN(valor)) {
                showToast('O valor do empréstimo deve ser um número positivo.', 'error');
                return;
            }
            if (taxa < 0 || isNaN(taxa)) {
                showToast('A taxa de juros não pode ser negativa.', 'error');
                return;
            }
            if (parcelas < 1 || isNaN(parcelas)) {
                showToast('O número de parcelas deve ser no mínimo 1.', 'error');
                return;
            }
            if (!frequencia) { 
                showToast('A frequência de pagamento é obrigatória.', 'error');
                return;
            }
            if (!data) {
                showToast('A data do empréstimo é obrigatória.', 'error');
                return;
            }
            if (valorParcela <= 0 || isNaN(valorParcela)) {
                showToast('Não foi possível calcular o valor da parcela. Verifique os valores.', 'error');
                return;
            }

            const newLoan = {
                id: Date.now(), 
                clienteId,
                valor,
                taxa,
                parcelas,
                frequencia, 
                data,
                valorParcela
            };

            database.emprestimos.push(newLoan);
            generateInstallments(newLoan); 
            database.saveToLocalStorage();
            elements.forms.emprestimo.reset();
            document.getElementById('valor-parcela').value = ''; 
            switchTab('emprestimos');
            showReceipt('emprestimo', newLoan); 
            showToast('Empréstimo registrado com sucesso!', 'success');
        }

        // Register a payment for an installment
        function registerPayment() {
            const emprestimoId = parseInt(elements.selects.emprestimoPagamento.value);
            const parcelaId = parseInt(elements.selects.parcelaPagamento.value); 
            const valorPagamento = parseFloat(document.getElementById('valor-pagamento').value);
            const dataPagamento = document.getElementById('data-pagamento').value;
            const formaPagamento = document.getElementById('forma-pagamento').value;

            console.log('Attempting to register payment for installment ID:', parcelaId); 
            if (!emprestimoId) {
                showToast('Selecione um empréstimo para registrar o pagamento.', 'error');
                return;
            }
            if (isNaN(parcelaId)) { 
                showToast('Selecione uma parcela para registrar o pagamento.', 'error');
                return;
            }
            if (valorPagamento <= 0 || isNaN(valorPagamento)) {
                showToast('O valor do pagamento deve ser um número positivo.', 'error');
                return;
            }
            if (!dataPagamento) {
                showToast('A data do pagamento é obrigatória.', 'error');
                return;
            }
            if (!formaPagamento) {
                showToast('A forma de pagamento é obrigatória.', 'error');
                return;
            }

            const installmentToPay = database.getPagamento(parcelaId); 
            console.log('Installment found:', installmentToPay); 
            if (!installmentToPay) {
                showToast('Parcela não encontrada. Por favor, recarregue e tente novamente. (ID: ' + parcelaId + ')', 'error');
                return;
            }
            if (installmentToPay.status === 'paid' && installmentToPay.valorRestante <= 0) { // Check if fully paid
                showToast('Esta parcela já foi totalmente paga!', 'info');
                return;
            }

            let message = '';
            let isPartialPayment = false;
            let amountPaidForThisTransaction = valorPagamento;

            if (valorPagamento < installmentToPay.valorRestante) {
                // Partial payment
                installmentToPay.valorRestante -= valorPagamento;
                message = 'Pagamento parcial registrado com sucesso!';
                isPartialPayment = true;
                // No status change, remains 'pending' or 'overdue'
            } else {
                // Full payment or overpayment
                amountPaidForThisTransaction = installmentToPay.valorRestante; // Only consider amount up to remaining
                if (valorPagamento > installmentToPay.valorRestante) {
                    showToast(`Valor pago (R$ ${valorPagamento.toFixed(2).replace('.', ',')}) é maior que o saldo restante (R$ ${installmentToPay.valorRestante.toFixed(2).replace('.', ',')}). Registrando o saldo restante e o excedente será considerado como adiantamento.`, 'warning');
                    // In a real app, you'd handle overpayment/change. Here, we'll mark as paid and showToast.
                }

                installmentToPay.valorRestante = 0; // Mark remaining as zero
                installmentToPay.status = 'paid';
                message = 'Pagamento registrado com sucesso!';
            }

            // Accumulate valorPago only for full payments or first partial payment
            // For subsequent partial payments, we just track valorRestante
            if (!installmentToPay.valorPago) {
                installmentToPay.valorPago = 0;
            }
            installmentToPay.valorPago += valorPagamento; // Sum all payments made against this installment

            installmentToPay.dataPagamento = dataPagamento;
            installmentToPay.formaPagamento = formaPagamento;

            const emprestimo = database.getEmprestimo(emprestimoId);
            const cliente = database.getCliente(emprestimo.clienteId);

            // Record a receipt for this specific transaction
            database.recibos.push({
                numero: database.proximoNumeroRecibo++,
                tipo: 'pagamento',
                data: new Date().toISOString().split('T')[0],
                clienteId: cliente.id, 
                emprestimoId: emprestimo.id, 
                parcelaNumero: installmentToPay.parcelaNumero, 
                valor: amountPaidForThisTransaction, // The specific amount paid in THIS transaction
                descricao: `Pagamento ${isPartialPayment ? 'parcial ' : ''}da parcela ${installmentToPay.parcelaNumero}/${emprestimo.parcelas} (Ref. Empréstimo #${emprestimo.id}). Saldo restante: ${formatCurrency(installmentToPay.valorRestante)}.`,
                formaPagamento: formaPagamento,
                isPartial: isPartialPayment // New flag for receipt type
            });

            database.saveToLocalStorage();
            elements.forms.pagamento.reset();
            elements.selects.parcelaPagamento.innerHTML = '<option value="">Selecione uma parcela</option>'; 
            document.getElementById('valor-pagamento').value = ''; 
            updateUI();
            showReceipt('pagamento', installmentToPay); 
            showToast(message, 'success');
        }

        // Add an observation
        function addObservation() {
            const clienteId = elements.selects.clienteObservacao.value ? parseInt(elements.selects.clienteObservacao.value) : null;
            const texto = elements.inputs.textoObservacao.value.trim();

            if (!texto) {
                showToast('A observação não pode estar vazia.', 'error');
                return;
            }

            database.observacoes.push({
                id: Date.now(),
                clienteId: clienteId,
                texto: texto,
                data: new Date().toISOString().split('T')[0]
            });
            database.saveToLocalStorage();
            elements.forms.observacao.reset();
            elements.selects.clienteObservacao.value = ''; 
            updateUI();
            showToast('Observação adicionada com sucesso!', 'success');
        }

        // Delete an observation
        window.deleteObservation = function(id) {
            if (confirm('Tem certeza que deseja excluir esta observação?')) {
                database.observacoes = database.observacoes.filter(obs => obs.id !== id);
                database.saveToLocalStorage();
                updateUI();
                showToast('Observação excluída com sucesso!', 'success');
            }
        };

        // Edit client (pre-fills form)
        window.editClient = function(id) {
            const client = database.getCliente(id);
            if (client) {
                document.getElementById('nome-cliente').value = client.nome;
                document.getElementById('cpf-cliente').value = formatCPF(client.cpf);
                document.getElementById('telefone-cliente').value = formatPhone(client.telefone);
                document.getElementById('email-cliente').value = client.email || '';
                document.getElementById('endereco-cliente').value = client.endereco || '';
                elements.inputs.observacaoCliente.value = client.observacao || ''; // Load existing observation

                elements.inputs.fotoPreview.src = client.foto || 'https://via.placeholder.com/100?text=Sem+Foto';
                elements.inputs.fotoCliente.value = ''; 

                for (let i = 1; i <= 3; i++) {
                    const contact = client.contatosEmergencia?.[i - 1]; 
                    elements.inputs[`contatoEmergencia${i}Nome`].value = contact?.nome || '';
                    elements.inputs[`contatoEmergencia${i}Cpf`].value = contact?.cpf ? formatCPF(contact.cpf) : '';
                    elements.inputs[`contatoEmergencia${i}Telefone`].value = contact?.telefone ? formatPhone(contact.telefone) : '';
                }

                elements.forms.cliente.dataset.editId = client.id; // Set edit ID
                switchTab('novo-cliente');
                showToast('Cliente carregado para edição. Salve para atualizar.', 'info');
            } else {
                showToast('Cliente não encontrado para edição.', 'error');
            }
        };

        // Delete client
        window.deleteClient = function(id) {
            if (confirm('Tem certeza que deseja excluir este cliente? Isso também removerá seus empréstimos, pagamentos e observações associadas.')) {
                const loansToDelete = database.emprestimos.filter(loan => loan.clienteId === id);
                loansToDelete.forEach(loan => {
                    database.pagamentos = database.pagamentos.filter(payment => payment.emprestimoId !== loan.id);
                });
                database.emprestimos = database.emprestimos.filter(loan => loan.clienteId !== id);
                database.observacoes = database.observacoes.filter(obs => obs.clienteId === id); // Remove specific client observations
                database.clientes = database.clientes.filter(c => c.id !== id);

                database.saveToLocalStorage();
                updateUI();
                showToast('Cliente e dados associados excluídos com sucesso!', 'success');
            }
        };

        // --- Data Display & Logic ---

        // Calculate and display installment value for new loan form
        function calculateInstallmentValue() {
            const valor = parseFloat(document.getElementById('valor-emprestimo').value) || 0;
            const taxa = parseFloat(document.getElementById('taxa-emprestimo').value) || 0;
            const parcelas = parseInt(document.getElementById('parcelas-emprestimo').value) || 1;
            const frequencia = elements.selects.frequenciaPagamento.value;

            if (valor > 0 && parcelas > 0 && frequencia) {
                const taxaMensalDecimal = taxa / 100; 
                let ratePerPeriod = 0; 

                switch (frequencia) {
                    case 'Mensal':
                        ratePerPeriod = taxaMensalDecimal;
                        break;
                    case 'Quinzenal':
                        ratePerPeriod = taxaMensalDecimal / 2; // Assuming 2 quinzenas por mês
                        break;
                    case 'Semanal':
                        ratePerPeriod = taxaMensalDecimal / (30 / 7); // Approx. 4.28 semanas por mês
                        break;
                    case 'Diária':
                        ratePerPeriod = taxaMensalDecimal / 30; // 30 dias por mês
                        break;
                }

                let installmentValue;
                if (ratePerPeriod === 0) {
                    installmentValue = valor / parcelas;
                } else {
                    installmentValue = valor * (ratePerPeriod * Math.pow(1 + ratePerPeriod, parcelas)) / (Math.pow(1 + ratePerPeriod, parcelas) - 1);
                }

                document.getElementById('valor-parcela').value = formatCurrency(installmentValue);
            } else {
                document.getElementById('valor-parcela').value = '';
            }
        }

        // Generate installments for a new loan
        function generateInstallments(loan) {
            const loanDate = new Date(loan.data + 'T12:00:00'); 

            for (let i = 1; i <= loan.parcelas; i++) {
                const dueDate = new Date(loanDate); 

                switch (loan.frequencia) {
                    case 'Mensal':
                        dueDate.setMonth(loanDate.getMonth() + i);
                        // Adjust day for month overflow
                        if (dueDate.getDate() !== loanDate.getDate()) {
                           dueDate.setDate(0); 
                           dueDate.setMonth(loanDate.getMonth() + i); 
                        }
                        break;
                    case 'Quinzenal':
                        dueDate.setDate(loanDate.getDate() + (15 * i));
                        break;
                    case 'Semanal':
                        dueDate.setDate(loanDate.getDate() + (7 * i));
                        break;
                    case 'Diária':
                        dueDate.setDate(loanDate.getDate() + i);
                        break;
                }
                
                database.pagamentos.push({
                    id: database.nextInstallmentId++, 
                    emprestimoId: loan.id,
                    parcelaNumero: i,
                    valor: loan.valorParcela,
                    valorRestante: loan.valorParcela, // New: track remaining value for partial payments
                    dataVencimento: dueDate.toISOString().split('T')[0], 
                    status: 'pending',
                    valorPago: 0, 
                    dataPagamento: null,
                    formaPagamento: null
                });
            }
        }


        // Load clients into the loan registration dropdown
        function loadClientsForLoan() {
            elements.selects.clienteEmprestimo.innerHTML = '<option value="">Selecione um cliente</option>';

            if (database.clientes.length === 0) {
                const option = document.createElement('option');
                option.value = '';
                option.textContent = 'Nenhum cliente cadastrado. Cadastre um primeiro!';
                option.disabled = true;
                elements.selects.clienteEmprestimo.appendChild(option);
                showToast('Nenhum cliente disponível. Por favor, cadastre um novo cliente primeiro.', 'info');
                return;
            }

            database.clientes.forEach(cliente => {
                const option = document.createElement('option');
                option.value = cliente.id;
                option.textContent = `${cliente.nome} (${formatCPF(cliente.cpf)})`;
                elements.selects.clienteEmprestimo.appendChild(option);
            });
        }

        // Load clients into the observations dropdown
        function loadClientsForObservations() {
            elements.selects.clienteObservacao.innerHTML = '<option value="">Observação geral ou selecione um cliente</option>';
            if (database.clientes.length > 0) {
                database.clientes.forEach(cliente => {
                    const option = document.createElement('option');
                    option.value = cliente.id;
                    option.textContent = `${cliente.nome} (${formatCPF(cliente.cpf)})`;
                    elements.selects.clienteObservacao.appendChild(option);
                });
            }
            updateObservationList(); 
        }

        // Load loans into the payment registration dropdown
        function loadLoansForPayment() {
            elements.selects.emprestimoPagamento.innerHTML = '<option value="">Selecione um empréstimo</option>';
            elements.selects.parcelaPagamento.innerHTML = '<option value="">Selecione uma parcela</option>'; 
            document.getElementById('valor-pagamento').value = '';

            if (database.emprestimos.length === 0) {
                const option = document.createElement('option');
                option.value = '';
                option.textContent = 'Nenhum empréstimo disponível. Registre um empréstimo primeiro!';
                option.disabled = true;
                elements.selects.emprestimoPagamento.appendChild(option);
                showToast('Nenhum empréstimo disponível. Registre um empréstimo para registrar pagamentos.', 'info');
                return;
            }

            database.emprestimos.forEach(emprestimo => {
                const cliente = database.getCliente(emprestimo.clienteId);
                if (cliente) {
                    const option = document.createElement('option');
                    option.value = emprestimo.id;
                    option.textContent = `${cliente.nome} - R$ ${emprestimo.valor.toLocaleString('pt-BR', {minimumFractionDigits: 2})} (${emprestimo.parcelas}x, ${emprestimo.frequencia})`;
                    elements.selects.emprestimoPagamento.appendChild(option);
                }
            });
        }

        // Update installment options when a loan is selected in payment form
        function updateParcelasForPayment() {
            const emprestimoId = parseInt(elements.selects.emprestimoPagamento.value);
            elements.selects.parcelaPagamento.innerHTML = '<option value="">Selecione uma parcela</option>';
            document.getElementById('valor-pagamento').value = '';

            if (isNaN(emprestimoId)) { 
                return;
            }

            const pendingInstallments = database.getParcelasPendentesEmprestimo(emprestimoId).sort((a, b) => a.parcelaNumero - b.parcelaNumero);

            if (pendingInstallments.length === 0) {
                const option = document.createElement('option');
                option.value = '';
                option.textContent = 'Todas as parcelas pagas para este empréstimo!';
                option.disabled = true;
                elements.selects.parcelaPagamento.appendChild(option);
                showToast('Todas as parcelas deste empréstimo já foram pagas.', 'info');
                return;
            }

            pendingInstallments.forEach(parcela => {
                const option = document.createElement('option');
                option.value = parcela.id; 
                option.textContent = `Parcela ${parcela.parcelaNumero} - Saldo: ${formatCurrency(parcela.valorRestante)} - Venc: ${formatDate(parcela.dataVencimento)}`; // Show remaining balance
                elements.selects.parcelaPagamento.appendChild(option);
            });

            if (pendingInstallments.length > 0) {
                elements.selects.parcelaPagamento.value = pendingInstallments[0].id; 
                document.getElementById('valor-pagamento').value = pendingInstallments[0].valorRestante.toFixed(2); // Pre-fill with remaining balance
                document.getElementById('valor-pagamento').max = pendingInstallments[0].valorRestante.toFixed(2); // Max is remaining balance
                document.getElementById('valor-pagamento').min = 0.01; // Min payment is 0.01
                document.getElementById('data-pagamento').value = new Date().toISOString().split('T')[0];
            }
        }

        // Filter payments list by status
        function filterPayments() {
            updatePaymentList(elements.selects.filterStatus.value);
        }

        // Filter clients list by search term
        function filterClients() {
            const searchTerm = elements.searchClientInput.value.toLowerCase().trim();
            const filteredClients = database.clientes.filter(client =>
                client.nome.toLowerCase().includes(searchTerm) ||
                client.cpf.includes(searchTerm.replace(/\D/g, '')) 
            );
            updateClientList(filteredClients);
        }

        // Export all data to CSV files
        function exportData() {
            const createCSV = (data, headers) => {
                const headerRow = headers.map(h => `"${h}"`).join(';');
                const dataRows = data.map(item =>
                    headers.map(header => {
                        let value = item[header];
                        if (typeof value === 'number') {
                            value = value.toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 }).replace('.', '').replace(',', '.');
                        } else if (value instanceof Date) {
                            value = value.toISOString().split('T')[0];
                        } else if (typeof value === 'object' && value !== null) { 
                            value = JSON.stringify(value).replace(/"/g, '""'); 
                            value = `"${value}"`; 
                        }
                        else if (typeof value === 'string' && (value.includes(';') || value.includes('"') || value.includes('\n'))) {
                            value = `"${value.replace(/"/g, '""')}"`;
                        } else if (value === null || value === undefined) {
                            value = '';
                        }
                        return value;
                    }).join(';')
                ).join('\n');

                return `\ufeff${headerRow}\n${dataRows}`;
            };

            const clientHeaders = ['id', 'nome', 'cpf', 'telefone', 'email', 'endereco', 'foto', 'contatosEmergencia', 'observacao']; 
            const loanHeaders = ['id', 'clienteId', 'valor', 'taxa', 'parcelas', 'frequencia', 'data', 'valorParcela']; 
            const paymentHeaders = ['id', 'emprestimoId', 'parcelaNumero', 'valor', 'valorRestante', 'dataVencimento', 'status', 'valorPago', 'dataPagamento', 'formaPagamento'];
            const observationHeaders = ['id', 'clienteId', 'texto', 'data']; 

            downloadLink(createCSV(database.clientes, clientHeaders), 'wolfcred_clientes.csv');
            downloadLink(createCSV(database.emprestimos, loanHeaders), 'wolfcred_emprestimos.csv');
            downloadLink(createCSV(database.pagamentos, paymentHeaders), 'wolfcred_pagamentos.csv');
            downloadLink(createCSV(database.observacoes, observationHeaders), 'wolfcred_observacoes.csv'); 

            showToast('Dados exportados para CSV com sucesso!', 'success');
        }

        // Generate a text report
        function generateReport() {
            const today = new Date().toISOString().split('T')[0];
            const paymentsToday = database.getPagamentosHoje();
            const pendingPayments = database.pagamentos.filter(p => p.status === 'pending');
            const overduePayments = database.pagamentos.filter(p => p.status === 'overdue'); 
            const totalPaidValue = database.getTotalPago();

            let reportContent = `Relatório Financeiro WolfCred - ${formatDate(today)}\n\n`;
            reportContent += `====================================\n`;
            reportContent += `RESUMO GERAL\n`;
            reportContent += `====================================\n`;
            reportContent += `Total de Clientes: ${database.clientes.length}\n`;
            reportContent += `Total de Empréstimos Ativos: ${database.emprestimos.length}\n`;
            reportContent += `Total de Parcelas Pendentes: ${pendingPayments.length}\n`;
            reportContent += `Total de Parcelas Atrasadas: ${overduePayments.length}\n`;
            reportContent += `Valor Total Pendente: ${formatCurrency(database.getTotalPendente())}\n`;
            reportContent += `Valor Total Pago: ${formatCurrency(totalPaidValue)}\n\n`;

            reportContent += `====================================\n`;
            reportContent += `ATIVIDADES DO DIA (${formatDate(today)})\n`;
            reportContent += `====================================\n`;
            if (paymentsToday.length > 0) {
                reportContent += `Pagamentos Registrados Hoje: ${paymentsToday.length}\n`;
                paymentsToday.forEach(payment => {
                    const loan = database.getEmprestimo(payment.emprestimoId);
                    const client = database.getCliente(loan?.clienteId);
                    reportContent += `- ${client?.nome || 'N/A'} (Parcela ${payment.parcelaNumero}): ${formatCurrency(payment.valorPago)} - ${payment.formaPagamento}\n`;
                });
            } else {
                reportContent += `Nenhum pagamento registrado hoje.\n`;
            }
            reportContent += `\n`;

            reportContent += `====================================\n`;
            reportContent += `PRÓXIMOS VENCIMENTOS (Pendentes)\n`;
            reportContent += `====================================\n`;
            const upcomingPayments = [...pendingPayments, ...overduePayments] 
                .sort((a, b) => new Date(a.dataVencimento) - new Date(b.dataVencimento))
                .slice(0, 10);

            if (upcomingPayments.length > 0) {
                upcomingPayments.forEach(payment => {
                    const loan = database.getEmprestimo(payment.emprestimoId);
                    const client = database.getCliente(loan?.clienteId);
                    reportContent += `- ${client?.nome || 'N/A'} (Parcela ${payment.parcelaNumero}): ${formatCurrency(payment.valorRestante)} - Venc: ${formatDate(payment.dataVencimento)} ${payment.status === 'overdue' ? '(ATRASADO!)' : ''}\n`;
                });
            } else {
                reportContent += `Nenhum pagamento pendente no momento.\n`;
            }
            reportContent += `\n`;

            reportContent += `====================================\n`;
            reportContent += `DETALHES DE CLIENTES (Amostra)\n`;
            reportContent += `====================================\n`;
            if (database.clientes.length > 0) {
                database.clientes.slice(0, 5).forEach(client => {
                    reportContent += `Nome: ${client.nome}\n`;
                    reportContent += `CPF: ${formatCPF(client.cpf)}\n`;
                    reportContent += `Telefone: ${formatPhone(client.telefone)}\n`;
                    reportContent += `Email: ${client.email || 'N/A'}\n`;
                    if (client.foto) {
                        reportContent += `Foto: (Disponível na aplicação)\n`;
                    }
                    if (client.contatosEmergencia && client.contatosEmergencia.length > 0) {
                        reportContent += `Contatos de Emergência:\n`;
                        client.contatosEmergencia.forEach((contact, index) => {
                            reportContent += `  - Contato ${index + 1}: ${contact.nome}, CPF: ${formatCPF(contact.cpf)}, Tel: ${formatPhone(contact.telefone)}\n`;
                        });
                    }
                    reportContent += `Observação: ${client.observacao || 'N/A'}\n`; // Include observation
                    const clientLoans = database.emprestimos.filter(loan => loan.clienteId === client.id);
                    if (clientLoans.length > 0) {
                        reportContent += `  Empréstimos (${clientLoans.length}):\n`;
                        clientLoans.forEach(loan => {
                            const clientPending = database.getParcelasPendentesEmprestimo(loan.id);
                            reportContent += `    - Valor: ${formatCurrency(loan.valor)}, Parcelas: ${loan.parcelas}, Pendentes: ${clientPending.length}\n`;
                        });
                    } else {
                        reportContent += `  Nenhum empréstimo registrado.\n`;
                    }
                    reportContent += `------------------------------------\n`;
                });
            } else {
                reportContent += `Nenhum cliente para exibir.\n`;
            }

            const blob = new Blob([reportContent], { type: 'text/plain;charset=utf-8' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `wolfcred_relatorio_${today}.txt`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);

            showToast('Relatório detalhado gerado com sucesso!', 'success');
        }


        // Display a receipt modal
        function showReceipt(type, dataObject) { 
            let client = null;
            let loan = null;
            let payment = null; // Will be the installment object

            if (type === 'emprestimo') {
                loan = dataObject;
                client = database.getCliente(loan.clienteId);
            } else if (type === 'pagamento') {
                payment = dataObject; // dataObject is the installment
                loan = database.getEmprestimo(payment.emprestimoId);
                client = database.getCliente(loan?.clienteId);
            }

            if (!client || !loan) {
                console.error("showReceipt: Missing client or loan data.", {type, dataObject, client, loan});
                showToast('Erro ao gerar recibo: dados essenciais ausentes. Verifique o console.', 'error');
                return;
            }

            let receiptNumberText = '';
            if (type === 'emprestimo') {
                receiptNumberText = String(loan.id).slice(-6); 
            } else { 
                const relevantReceipt = database.recibos.slice().reverse().find(r => 
                    r.tipo === 'pagamento' && 
                    r.clienteId === client.id && 
                    r.emprestimoId === loan.id &&
                    r.parcelaNumero === payment.parcelaNumero &&
                    (r.valor.toFixed(2) === (payment.valorPago || payment.valor).toFixed(2)) 
                );
                receiptNumberText = relevantReceipt ? String(relevantReceipt.numero).padStart(6, '0') : 'N/A';
            }

            const valueToDisplay = (type === 'emprestimo') ? loan.valor : (payment.valorPago > 0 ? payment.valorPago : payment.valor); // Use valorPago if it's a payment and paid.


            document.getElementById('recibo-tipo').textContent = (type === 'emprestimo') ? 'RECIBO DE EMPRÉSTIMO' : 'RECIBO DE PAGAMENTO';
            document.getElementById('recibo-numero').textContent = receiptNumberText;
            document.getElementById('recibo-data').textContent = formatDate(payment?.dataPagamento || loan.data || payment?.dataVencimento); 
            document.getElementById('recibo-cliente').textContent = client.nome;
            document.getElementById('recibo-cpf').textContent = formatCPF(client.cpf);
            document.getElementById('recibo-valor').textContent = formatCurrency(valueToDisplay); 
            document.getElementById('recibo-descricao').textContent = (type === 'emprestimo')
                ? `Empréstimo de ${loan.parcelas} parcelas ${loan.frequencia ? `(${loan.frequencia})` : ''} a uma taxa de ${loan.taxa}% a.m.`
                : `Pagamento da parcela ${payment.parcelaNumero}/${loan.parcelas} do empréstimo.`; // Use loan.parcelas for total
            document.getElementById('recibo-forma').textContent = payment?.formaPagamento || 'Não aplicável';

            elements.modals.recibo.dataset.clientId = client.id; 
            elements.modals.recibo.dataset.loanId = loan.id; 
            elements.modals.recibo.dataset.paymentId = payment?.id || ''; 
            elements.modals.recibo.dataset.receiptType = type; // Store the receipt type

            elements.modals.recibo.classList.add('show');
        }

        // --- New: View Client Profile ---
        window.viewClientProfile = function(clientId) {
            const client = database.getCliente(clientId);
            if (!client) {
                showToast('Cliente não encontrado.', 'error');
                return;
            }

            // Fill personal details
            elements.profileDetails.foto.src = client.foto || 'https://via.placeholder.com/100?text=NF';
            elements.profileDetails.nome.textContent = client.nome;
            elements.profileDetails.cpf.textContent = formatCPF(client.cpf);
            elements.profileDetails.telefone.textContent = formatPhone(client.telefone);
            elements.profileDetails.email.textContent = client.email || 'N/A';
            elements.profileDetails.endereco.textContent = client.endereco || 'N/A';
            elements.profileDetails.observacao = client.observacao || 'N/A'; // Show client observation

            // Fill emergency contacts
            elements.profileDetails.contatosEmergencia.innerHTML = '<h3>Contatos de Emergência</h3>';
            if (client.contatosEmergencia && client.contatosEmergencia.length > 0) {
                client.contatosEmergencia.forEach((contact, index) => {
                    const contactDiv = document.createElement('div');
                    contactDiv.innerHTML = `
                        <p><strong>Contato ${index + 1}:</strong> ${contact.nome}</p>
                        <p style="margin-left: 20px;">CPF: ${formatCPF(contact.cpf)}</p>
                        <p style="margin-left: 20px;">Telefone: ${formatPhone(contact.telefone)}</p>
                    `;
                    elements.profileDetails.contatosEmergencia.appendChild(contactDiv);
                });
            } else {
                elements.profileDetails.contatosEmergencia.innerHTML += '<p>Nenhum contato de emergência registrado.</p>';
            }

            // Fill loans history
            elements.profileDetails.emprestimosHistorico.innerHTML = '';
            const clientLoans = database.emprestimos.filter(loan => loan.clienteId === clientId);
            if (clientLoans.length > 0) {
                clientLoans.sort((a, b) => new Date(b.data) - new Date(a.data)); // Sort by most recent loan first
                clientLoans.forEach(loan => {
                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td>${formatCurrency(loan.valor)}</td>
                        <td>${loan.parcelas}x</td>
                        <td>${loan.taxa}%</td>
                        <td>${loan.frequencia}</td>
                        <td>${formatDate(loan.data)}</td>
                    `;
                    elements.profileDetails.emprestimosHistorico.appendChild(tr);
                });
            } else {
                elements.profileDetails.emprestimosHistorico.innerHTML = '<tr><td colspan="5" class="empty-message">Nenhum empréstimo registrado.</td></tr>';
            }

            // Fill payments history
            elements.profileDetails.pagamentosHistorico.innerHTML = '';
            const clientPayments = database.pagamentos.filter(p => {
                const loan = database.getEmprestimo(p.emprestimoId);
                return loan && loan.clienteId === clientId;
            });
            if (clientPayments.length > 0) {
                clientPayments.sort((a, b) => new Date(b.dataPagamento || b.dataVencimento) - new Date(a.dataPagamento || a.dataVencimento)); // Sort by most recent payment/due date
                clientPayments.forEach(payment => {
                    const loanOfPayment = database.getEmprestimo(payment.emprestimoId);
                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td>${payment.parcelaNumero}/${loanOfPayment?.parcelas || '?'}</td>
                        <td>${formatCurrency(payment.valor)}</td>
                        <td>${formatDate(payment.dataVencimento)}</td>
                        <td><span class="status status-${payment.status}">${getStatusText(payment.status)}</span></td>
                        <td>${payment.dataPagamento ? formatDate(payment.dataPagamento) : 'N/A'}</td>
                        <td>${payment.formaPagamento || 'N/A'}</td>
                    `;
                    elements.profileDetails.pagamentosHistorico.appendChild(tr);
                });
            } else {
                elements.profileDetails.pagamentosHistorico.innerHTML = '<tr><td colspan="6" class="empty-message">Nenhum pagamento registrado.</td></tr>';
            }

            elements.modals.perfilCliente.classList.add('show');
        };


        function updateUI() {
            updateClientList();
            updateLoanList();
            updatePaymentList(elements.selects.filterStatus.value);
            updateLatestLoansList();
            updateDashboard();
            loadClientsForLoan(); // Ensure loan client dropdown is updated
            loadClientsForObservations(); // Ensure observation client dropdown is updated
            loadLoansForPayment(); // Ensure payment loan dropdown is updated
            updateObservationList(); 
        }

        // Update clients table
        function updateClientList(clients = database.clientes) {
            elements.lists.clientes.innerHTML = '';

            if (clients.length === 0) {
                elements.lists.clientes.innerHTML = '<tr><td colspan="4" class="empty-message">Nenhum cliente cadastrado ou encontrado.</td></tr>';
                return;
            }

            clients.forEach(client => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>
                        <img src="${client.foto || 'https://via.placeholder.com/50?text=NF'}" alt="Foto" style="width: 40px; height: 40px; border-radius: 50%; object-fit: cover; margin-right: 10px;">
                        ${client.nome}
                    </td>
                    <td>${formatCPF(client.cpf)}</td>
                    <td>${formatPhone(client.telefone)}</td>
                    <td class="action-buttons">
                        <button class="btn btn-info btn-sm" onclick="editClient(${client.id})">
                            <i class="fas fa-edit"></i> Editar
                        </button>
                        <button class="btn btn-success btn-sm" onclick="sendWhatsAppClient(${client.id})">
                            <i class="fab fa-whatsapp"></i> WhatsApp
                        </button>
                        <button class="btn btn-primary btn-sm" onclick="viewClientProfile(${client.id})">
                            <i class="fas fa-user"></i> Perfil
                        </button>
                        <button class="btn btn-danger btn-sm" onclick="deleteClient(${client.id})">
                            <i class="fas fa-trash"></i> Excluir
                        </button>
                    </td>
                `;
                elements.lists.clientes.appendChild(tr);
            });
        }

        // Update loans table
        function updateLoanList() {
            elements.lists.emprestimos.innerHTML = '';

            if (database.emprestimos.length === 0) {
                elements.lists.emprestimos.innerHTML = '<tr><td colspan="7" class="empty-message">Nenhum empréstimo registrado</td></tr>';
                return;
            }

            database.emprestimos.forEach(loan => {
                const client = database.getCliente(loan.clienteId) || { nome: 'Cliente não encontrado' };
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${client.nome}</td>
                    <td>${formatCurrency(loan.valor)}</td>
                    <td>${loan.parcelas}x</td>
                    <td>${loan.taxa}%</td>
                    <td>${loan.frequencia || 'N/A'}</td> 
                    <td>${formatDate(loan.data)}</td>
                    <td class="action-buttons">
                        <button class="btn btn-primary btn-sm" onclick="viewLoanDetails(${loan.id})">
                            <i class="fas fa-eye"></i> Detalhes
                        </button>
                    </td>
                `;
                elements.lists.emprestimos.appendChild(tr);
            });
        }

        // Update payments table and dashboard's "latest payments"
        function updatePaymentList(statusFilter = 'all') {
            elements.lists.pagamentos.innerHTML = '';
            elements.lists.ultimosPagamentos.innerHTML = ''; // Clear dashboard latest payments as well

            checkOverduePayments();

            let filteredPayments = database.pagamentos;

            if (statusFilter === 'paid') {
                filteredPayments = database.pagamentos.filter(p => p.status === 'paid');
            } else if (statusFilter === 'pending') {
                filteredPayments = database.pagamentos.filter(p => p.status === 'pending');
            } else if (statusFilter === 'overdue') {
                filteredPayments = database.pagamentos.filter(p => p.status === 'overdue');
            }

            filteredPayments.sort((a, b) => {
                const dateA = new Date(a.dataVencimento || a.dataPagamento);
                const dateB = new Date(b.dataVencimento || b.dataPagamento);

                if (a.status === 'overdue' && b.status !== 'overdue') return -1;
                if (b.status === 'overdue' && a.status !== 'overdue') return 1;
                if (a.status === 'pending' && b.status === 'pending') {
                    return dateA - dateB;
                }
                if (a.status === 'paid' && b.status === 'paid') {
                    return dateB - dateA; 
                }
                return 0;
            });

            if (filteredPayments.length === 0) {
                elements.lists.pagamentos.innerHTML = '<tr><td colspan="7" class="empty-message">Nenhum pagamento encontrado com este filtro.</td></tr>';
            } else {
                filteredPayments.forEach(payment => {
                    const loan = database.getEmprestimo(payment.emprestimoId);
                    const client = database.getCliente(loan?.clienteId);

                    if (loan && client) {
                        const tr = document.createElement('tr');
                        tr.innerHTML = `
                                        <td>${client.nome}</td>
                                        <td>${formatCurrency(loan.valor)}</td>
                                        <td>${payment.parcelaNumero}/${loan.parcelas}</td>
                                        <td>${formatCurrency(payment.valorRestante)}</td> <td>${formatDate(payment.dataVencimento)}</td>
                                        <td><span class="status status-${payment.status}">${getStatusText(payment.status)}</span></td>
                                        <td class="action-buttons">
                                            ${payment.valorRestante > 0 ? // Only show Pagar if still something to pay
                                                `<button class="btn btn-success btn-sm" onclick="registerPaymentForInstallment(${payment.id})">
                                                    <i class="fas fa-money-bill-wave"></i> Pagar
                                                </button>` :
                                                `<button class="btn btn-info btn-sm" onclick="viewReceiptForPayment(${payment.id})">
                                                    <i class="fas fa-receipt"></i> Recibo
                                                </button>`
                                            }
                                        </td>
                                    `;
                        elements.lists.pagamentos.appendChild(tr);

                        // Add to latest payments dashboard table if it's a paid payment
                        if (payment.status === 'paid' || payment.valorRestante <= 0) { // If fully paid or status is paid
                            const trLatest = document.createElement('tr');
                            trLatest.innerHTML = `
                                <td>${client.nome}</td>
                                <td>${formatCurrency(payment.valorPago)}</td>
                                <td>${formatDate(payment.dataPagamento)}</td>
                                <td><span class="status status-${payment.status}">${getStatusText(payment.status)}</span></td>
                            `;
                            elements.lists.ultimosPagamentos.appendChild(trLatest);
                        }
                    }
                });
            }

            // If no latest payments were added (either no payments or none are 'paid'), ensure empty message is displayed
            if (elements.lists.ultimosPagamentos.children.length === 0) {
                elements.lists.ultimosPagamentos.innerHTML = '<tr><td colspan="4" class="empty-message">Nenhum pagamento registrado</td></tr>';
            }
        }

        // Update latest loans on Dashboard
        function updateLatestLoansList() {
            elements.lists.ultimosEmprestimos.innerHTML = ''; 

            const latestLoans = [...database.emprestimos] 
                .sort((a, b) => new Date(b.data) - new Date(a.data)) 
                .slice(0, 5); 

            if (latestLoans.length === 0) {
                elements.lists.ultimosEmprestimos.innerHTML = '<tr><td colspan="5" class="empty-message">Nenhum empréstimo recente.</td></tr>';
                return;
            }

            latestLoans.forEach(loan => {
                    const client = database.getCliente(loan.clienteId) || { nome: 'Cliente não encontrado' };
                    const allInstallmentsForLoan = database.getParcelasEmprestimo(loan.id); 
                    const paidInstallments = allInstallmentsForLoan.filter(p => p.status === 'paid' && p.valorRestante <= 0).length; // Count only fully paid
                    const totalInstallments = allInstallmentsForLoan.length;

                    let loanStatusText = '';
                    let loanStatusClass = '';

                    if (totalInstallments === 0) { 
                        loanStatusText = 'N/A';
                        loanStatusClass = '';
                    } else if (paidInstallments === totalInstallments) {
                        loanStatusText = 'Completo';
                        loanStatusClass = 'status-paid';
                    } else if (allInstallmentsForLoan.some(p => p.status === 'overdue')) {
                        const overdueCount = allInstallmentsForLoan.filter(p => p.status === 'overdue').length;
                        loanStatusText = `Atrasado (${overdueCount}/${totalInstallments})`;
                        loanStatusClass = 'status-overdue';
                    } else { 
                        const pendingCount = totalInstallments - paidInstallments;
                        loanStatusText = `Pendente (${pendingCount}/${totalInstallments})`;
                        loanStatusClass = 'status-pending';
                    }


                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td>${client.nome}</td>
                        <td>${formatCurrency(loan.valor)}</td>
                        <td>${loan.parcelas}x</td>
                        <td>${formatDate(loan.data)}</td>
                        <td><span class="status ${loanStatusClass}">${loanStatusText}</span></td>
                    `;
                    elements.lists.ultimosEmprestimos.appendChild(tr);
                });
        }

        // Update observations table
        function updateObservationList() {
            elements.lists.observacoes.innerHTML = '';

            if (database.observacoes.length === 0) {
                elements.lists.observacoes.innerHTML = '<tr><td colspan="4" class="empty-message">Nenhuma observação registrada.</td></tr>';
                return;
            }

            const sortedObservations = [...database.observacoes].sort((a, b) => new Date(b.data) - new Date(a.data));

            sortedObservations.forEach(obs => {
                const client = obs.clienteId ? database.getCliente(obs.clienteId) : null;
                const clientName = client ? client.nome : 'Geral';
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${clientName}</td>
                    <td>${obs.texto}</td>
                    <td>${formatDate(obs.data)}</td>
                    <td class="action-buttons">
                        <button class="btn btn-danger btn-sm" onclick="deleteObservation(${obs.id})">
                            <i class="fas fa-trash"></i> Excluir
                        </button>
                    </td>
                `;
                elements.lists.observacoes.appendChild(tr);
            });
        }


        // Update dashboard statistics
        function updateDashboard() {
            elements.dashboard.totalClientes.textContent = database.clientes.length;
            elements.dashboard.totalEmprestimos.textContent = database.emprestimos.length;

            elements.dashboard.pagamentosHoje.textContent = database.getPagamentosHoje().length;

            const totalPendente = database.getTotalPendente();
            elements.dashboard.valorPendente.textContent = formatCurrency(totalPendente);

            elements.dashboard.pagamentosAtrasados.textContent = database.getPagamentosAtrasados().length;

            const totalPago = database.getTotalPago();
            elements.dashboard.valorTotalPago.textContent = formatCurrency(totalPago);

            if (totalPendente > 0) {
                elements.dashboard.cardValorPendente.classList.add('pulse');
            } else {
                elements.dashboard.cardValorPendente.classList.remove('pulse');
            }
        }

        // Check and update payment statuses (overdue)
        function checkOverduePayments() {
            const today = new Date().toISOString().split('T')[0];
            database.pagamentos.forEach(payment => {
                if (payment.status === 'pending' && payment.dataVencimento < today) {
                    payment.status = 'overdue';
                }
            });
            database.saveToLocalStorage(); 
        }

        // --- Utility Functions ---

        // Format date to Brazilian standard (DD/MM/YYYY)
        function formatDate(dateString) {
            if (!dateString) return 'N/A';
            try {
                const [year, month, day] = dateString.split('-');
                return `${day}/${month}/${year}`;
            } catch (e) {
                return dateString;
            }
        }

        // Format currency to Brazilian Real (R$)
        function formatCurrency(value) {
            return `R$ ${parseFloat(value).toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
        }

        // Format CPF (000.000.000-00)
        function formatCPF(cpf) {
            if (!cpf) return '';
            const cleaned = String(cpf).replace(/\D/g, '');
            if (cleaned.length === 11) {
                return cleaned.replace(/(\d{3})(\d{3})(\d{3})(\d{2})/, '$1.$2.$3-$4');
            }
            return cleaned; 
        }

        // Format Phone ((00) 00000-0000 or (00) 0000-0000)
        function formatPhone(phone) {
            if (!phone) return '';
            const cleaned = String(phone).replace(/\D/g, '');
            if (cleaned.length === 10) {
                return cleaned.replace(/(\d{2})(\d{4})(\d{4})/, '($1) $2-$3');
            } else if (cleaned.length === 11) {
                return cleaned.replace(/(\d{2})(\d{5})(\d{4})/, '($1) $2-$3');
            }
            return cleaned; 
        }

        // Get readable status text
        function getStatusText(status) {
            const statusMap = {
                'paid': 'Pago',
                'pending': 'Pendente',
                'overdue': 'Atrasado'
            };
            return statusMap[status] || status;
        }

        // Helper for CSV download
        function downloadLink(content, filename) {
            const blob = new Blob([content], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = filename;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        // Display a toast notification
        function showToast(message, type = 'info') {
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');
            toast.className = `toast toast-${type}`;

            let icon = '';
            switch(type) {
                case 'success': icon = '<i class="fas fa-check-circle"></i>'; break;
                case 'error': icon = '<i class="fas fa-exclamation-triangle"></i>'; break;
                case 'info': icon = '<i class="fas fa-info-circle"></i>'; break;
                case 'warning': icon = '<i class="fas fa-exclamation-circle"></i>'; break;
            }

            toast.innerHTML = `${icon} <span>${message}</span>`;
            container.appendChild(toast);

            setTimeout(() => {
                toast.style.opacity = '0';
                toast.style.marginBottom = `-${toast.offsetHeight + 15}px`; 
                setTimeout(() => toast.remove(), 500);
            }, 3000);
        }

        // Global functions for inline HTML calls (e.g., onclick)
        window.viewLoanDetails = function(id) {
            const loan = database.getEmprestimo(id);
            if (loan) {
                showReceipt('emprestimo', loan); 
            }
        };

        window.registerPaymentForInstallment = function(installmentId) {
            console.log('registerPaymentForInstallment called with ID:', installmentId); 
            const payment = database.getPagamento(parseInt(installmentId)); 
            if (payment) {
                console.log('Payment object found:', payment); 
                const loan = database.getEmprestimo(payment.emprestimoId);
                if (loan) {
                    console.log('Loan object found for payment:', loan); 
                    
                    elements.selects.emprestimoPagamento.value = loan.id;
                    // Directly trigger the change event to populate parcelas dropdown
                    const event = new Event('change');
                    elements.selects.emprestimoPagamento.dispatchEvent(event);

                    // A small delay is still often necessary for the DOM to update
                    // and for the options to be available before trying to select one.
                    setTimeout(() => {
                        elements.selects.parcelaPagamento.value = payment.id; 
                        // Set min/max/value based on remaining amount
                        document.getElementById('valor-pagamento').min = 0.01;
                        document.getElementById('valor-pagamento').max = payment.valorRestante.toFixed(2);
                        document.getElementById('valor-pagamento').value = payment.valorRestante.toFixed(2);

                        document.getElementById('data-pagamento').value = new Date().toISOString().split('T')[0];
                        elements.selects.formaPagamento.value = '';
                        switchTab('registrar-pagamento');
                        showToast('Pagamento carregado para registro.', 'info');
                    }, 100); 
                } else {
                    console.error('Loan not found for payment:', payment.emprestimoId);
                    showToast('Empréstimo associado à parcela não encontrado. Verifique o console.', 'error');
                }
            } else {
                console.error('Payment (installment) not found for ID:', installmentId);
                showToast('Parcela não encontrada. Verifique o console para detalhes.', 'error');
            }
        };

        window.viewReceiptForPayment = function(installmentId) { 
            const payment = database.getPagamento(installmentId);
            if (payment) {
                showReceipt('pagamento', payment); 
            }
        };

        window.sendWhatsAppClient = function(clientId) {
            const client = database.getCliente(clientId);
            if (client && client.telefone) {
                const cleanedPhone = client.telefone.replace(/\D/g, ''); 
                const message = encodeURIComponent(`Olá ${client.nome}!\n\nSou da WolfCred e estou à disposição para informações sobre seu empréstimo.\n\nSe precisar de algo, é só me chamar aqui!`);
                const whatsappUrl = `https://wa.me/55${cleanedPhone}?text=${message}`; 
                window.open(whatsappUrl, '_blank');
                showToast(`Abrindo WhatsApp para ${client.nome}...`, 'info');
            } else {
                showToast('Número de telefone do cliente não encontrado.', 'error');
            }
        };

        function shareReceiptViaWhatsApp() {
            const clientId = elements.modals.recibo.dataset.clientId;
            const loanId = elements.modals.recibo.dataset.loanId;
            const paymentId = elements.modals.recibo.dataset.paymentId; 
            const receiptType = elements.modals.recibo.dataset.receiptType; // Get receipt type

            if (!clientId || !loanId) {
                showToast('Erro: Dados essenciais do recibo (cliente ou empréstimo) ausentes para compartilhar no WhatsApp.', 'error');
                console.error('WhatsApp Share Error: Missing clientId or loanId from receipt modal data attributes.', {clientId, loanId});
                return;
            }

            const client = database.getCliente(parseInt(clientId)); 
            const loan = database.getEmprestimo(parseInt(loanId));
            let payment = null;
            if (paymentId && receiptType === 'pagamento') { // Only try to get payment if it's a payment receipt
                payment = database.getPagamento(parseInt(paymentId));
            }

            if (!client || !client.telefone || !loan) {
                showToast('Não foi possível encontrar todos os dados necessários do cliente/empréstimo para compartilhar o recibo.', 'error');
                console.error('WhatsApp Share Error: Client, client phone or loan not found.', {client, loan});
                return;
            }

            const receiptNumber = document.getElementById('recibo-numero').textContent;
            const receiptDate = document.getElementById('recibo-data').textContent;
            const receiptClient = document.getElementById('recibo-cliente').textContent;
            const receiptValue = document.getElementById('recibo-valor').textContent;
            const receiptDescription = document.getElementById('recibo-descricao').textContent;
            const receiptFormaPagamento = document.getElementById('recibo-forma').textContent;


            const cleanedPhone = client.telefone.replace(/\D/g, '');
            // Updated WhatsApp message for better readability and detail
            let message = `*🧾 RECIBO WOLFCED - ${receiptType.toUpperCase()} 🧾*\n\n`;
            message += `*Número do Recibo:* ${receiptNumber}\n`;
            message += `*Data da Transação:* ${receiptDate}\n`;
            message += `*Cliente:* ${receiptClient}\n`;
            message += `*Valor:* ${receiptValue}\n`;
            message += `*Descrição:* ${receiptDescription}\n`;
            message += `*Forma de Pagamento:* ${receiptFormaPagamento}\n\n`;
            message += `Este é o comprovante oficial da sua transação na WolfCred.\n\n`;
            message += `Agradecemos a preferência! 🐺`;

            const whatsappUrl = `https://wa.me/55${cleanedPhone}?text=${encodeURIComponent(message)}`;
            window.open(whatsappUrl, '_blank');
            showToast('Recibo compartilhado via WhatsApp!', 'success');
        }
        
        window.addObservationToClient = function(clientId) {
            switchTab('observacoes');
            elements.selects.clienteObservacao.value = clientId;
            elements.inputs.textoObservacao.focus();
        };

        window.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>